<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity ‚Äî Whitelist</title>

<style>
  :root{
    color-scheme: dark;
    --card-w-welcome: 560px;
    --card-w-quiz:    720px;
  }
  body{ margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family:system-ui, Segoe UI, Roboto, Inter, Arial, sans-serif; }
  .stack{ display:grid; gap:16px; place-items:center; }
  .brand-center{ width:72px; height:auto; user-select:none; -webkit-user-drag:none; filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)); }

  .progress{ width:var(--card-w-welcome); text-align:center; transition:width .25s ease; }
  .progress.quiz{ width:var(--card-w-quiz); }
  .progress-track{ height:10px; border-radius:9999px; overflow:hidden; background:rgba(255,255,255,.15); box-shadow:inset 0 1px 2px rgba(0,0,0,.25); }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(135deg,#5edae7,#885dfd); border-radius:9999px; transition:width .35s ease; }
  .progress-label{ font-size:12px; color:#e5e7eb; margin-top:6px; opacity:.9; }
  .hidden{ display:none !important; }

  .card{ width:var(--card-w-welcome); padding:24px; border-radius:20px; background:linear-gradient(135deg,#5edae7,#885dfd); box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; color:#fff; transition:width .25s ease, padding .2s ease; }
  .inner{ background:rgba(0,0,0,.25); border-radius:16px; padding:18px; display:flex; flex-direction:column; justify-content:center; }

  .card.quiz{ width:var(--card-w-quiz); padding:18px; }
  .card.quiz .inner{ min-height:410px; padding:12px; }

  img.avatar{ width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 14px; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,.25); opacity:0; transition:opacity .25s ease; }
  img.avatar.hidden{ display:none; }
  img.avatar.revealed{ display:block; opacity:1; }

  h1{ font-size:20px; margin:8px 0 0; color:#fff; font-weight:700; min-height:1.2em; }
  #hint{ font-size:20px; font-weight:700; margin:6px 0 0; color:#fff; min-height:1.2em; opacity:.95; }
  .username{ color:#0c121e; }

  .spinner{ width:24px; height:24px; border:3px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; margin:14px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .err{ color:#ffe1e1 }

  .btn{ appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700; font-size:14px; transition:transform .05s ease, box-shadow .2s ease, opacity .2s ease; }
  .btn-primary{ background:#fff; color:#0b0f14; box-shadow:0 8px 18px rgba(0,0,0,.25); text-decoration:none; display:inline-block; }
  .btn-primary:hover{ transform:translateY(-1px); }
  .btn-primary:active{ transform:translateY(0); }
  .gtext{ background-image:linear-gradient(135deg,#5edae7,#885dfd); -webkit-background-clip:text; background-clip:text; color:transparent; display:inline-block; }

  .pill-outline{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:12px; user-select:none;
    border:2px solid transparent;
    background:
      linear-gradient(#0b0f14,#0b0f14) padding-box,
      linear-gradient(135deg,#5edae7,#885dfd) border-box;
    color:#eaf2ff; font-weight:700;
  }

  .step-title, #quiz-title{ font-size:18px; font-weight:800; margin:0 0 8px; color:#0c121e; }
  #quiz-q{ font-weight:700; font-size:16px; line-height:1.25; margin:6px 0 8px; }

  .form{ text-align:left; max-width:520px; margin:0 auto; }
  .card.quiz .form{ max-width:660px; }

  .field{ margin:10px 0 12px; }
  .label{ display:block; font-size:13px; margin-bottom:6px; color:#eef2ff; }
  .req{ color:#ffd3d3; margin-left:6px; font-size:12px; }

  .input, .textarea{ width:100%; box-sizing:border-box; border-radius:12px; border:1px solid transparent; background:rgba(0,0,0,.18); color:#fff; padding:9px 12px; font-size:14px; outline:none; }
  .input:focus, .textarea:focus{ border-color:#fff; background:rgba(255,255,255,.08); }

  .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width:740px){ .row-2{ grid-template-columns:1fr; } }

  .radios, .checks{ display:grid; grid-template-columns:1fr; gap:8px; }
  .check, .radio{ display:flex; align-items:center; gap:12px; padding:8px 14px; border:1px solid rgba(255,255,255,.28); border-radius:14px; background:rgba(0,0,0,.18); transition:border-color .2s ease, background .2s ease; }
  .radio:has(input:focus-visible), .check:has(input:focus-visible){ border-color:#fff; }
  .radio:has(input:checked), .check:has(input:checked){ border-color:#fff; background:rgba(255,255,255,.08); }
  .check span, .radio span{ font-size:14px; line-height:1.25; }

  .radio input, .check input{ appearance:none; width:20px; height:20px; border-radius:50%; border:2px solid #fff; background:transparent; display:inline-block; flex-shrink:0; }
  .radio input:checked, .check input:checked{ background:#0c121e; }

  .error{ color:#ffd3d3; font-size:12px; margin-top:6px; }
  .actions{ display:flex; gap:10px; justify-content:center; margin-top:10px; }
</style>
</head>

<body>
  <div class="stack">
    <img class="brand-center" src="logo.png" alt="Proyecto Roleplay" />

    <div id="progress" class="progress hidden" aria-hidden="true">
      <div class="progress-track"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressLabel" class="progress-label">Paso 1 de 11</div>
    </div>

    <div class="card">
      <div class="inner">
        <!-- Bienvenida -->
        <section id="welcome">
          <img id="avatar" class="avatar hidden" alt="" />
          <h1 id="name"></h1>
          <p id="hint">Identificando usuario‚Ä¶</p>
          <div class="spinner" id="spinner"></div>

          <div id="startWrap" class="hidden" style="margin-top:14px;">
            <button id="startBtn" type="button" class="btn btn-primary">
              <span class="gtext">Comenzar whitelist</span>
            </button>
          </div>
        </section>

        <!-- Paso 1 -->
        <section id="step1" class="hidden" aria-labelledby="step1-title">
          <p id="step1-title" class="step-title">Datos del jugador</p>

          <form id="formStep1" class="form" novalidate>
            <div class="row-2">
              <div class="field">
                <label class="label" for="edad">Edad <span class="req">*</span></label>
                <input id="edad" name="edad" class="input" type="text" inputmode="numeric" autocomplete="off" required />
                <div class="error" id="err-edad"></div>
              </div>
              <div class="field">
                <label class="label" for="pais">Pa√≠s <span class="req">*</span></label>
                <input id="pais" name="pais" class="input" type="text" autocomplete="country-name" required />
                <div class="error" id="err-pais"></div>
              </div>
            </div>

            <div class="field">
              <span class="label">Experiencia en rol <span class="req">*</span></span>
              <div class="radios" role="radiogroup">
                <label class="radio"><input type="radio" name="exp" value="principiante" required /> Principiante</label>
                <label class="radio"><input type="radio" name="exp" value="intermedia" /> Intermedia</label>
                <label class="radio"><input type="radio" name="exp" value="avanzada" /> Avanzada</label>
              </div>
              <div class="error" id="err-exp"></div>
            </div>

            <div class="field">
              <label class="label" for="conocido">¬øC√≥mo nos has conocido? <span style="opacity:.7">(opcional)</span></label>
              <textarea id="conocido" name="conocido" class="textarea" rows="3"></textarea>
            </div>

            <div class="actions">
              <button type="submit" class="btn btn-primary"><span class="gtext">Siguiente</span></button>
            </div>
          </form>
        </section>

        <!-- Cuestionario -->
        <section id="quiz" class="hidden" aria-live="polite">
          <p id="quiz-title" class="step-title"></p>
          <div id="quiz-q"></div>

          <form id="quiz-form" class="form">
            <div id="quiz-options" class="checks"></div>
            <div id="quiz-error" class="error"></div>
            <div class="actions">
              <button id="quiz-next" type="submit" class="btn btn-primary"><span class="gtext">Siguiente</span></button>
            </div>
          </form>
        </section>

        <!-- Final -->
        <section id="result" class="hidden">
          <p class="step-title">¬°Gracias!</p>
          <p id="scoreText" style="opacity:.95">
            Tu Whitelist se ha enviado exitosamente<br>
            Podr√°s encontrar tu resultado en unos segundos en el canal
          </p>
          <div class="pill-outline" style="margin-top:12px;" aria-hidden="true">
            üîî ‚îÉresultados
          </div>
        </section>

      </div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    const CLIENT_ID    = "1383517896747126987";
    const WEBHOOK_URL  = "https://discord.com/api/webhooks/1385716193066745997/ZoQ-DRAkE9ilPSQZQ23gU1b6uT3U_tMQ8Qcpmgx_2AvyrG8c1Ey75iAVeWKJ4wcKky-e";
    const RESULT_THRESHOLD = 7; // ‚â•7/10 = Aprobado

    /* ====== PREGUNTAS (p√°ginas 2‚Äì11) ====== */
    const QUIZ_PAGES = [
      { title: "Conocimientos Generales 1/5", questions: [
        { q:"Cu√°l de los siguientes conceptos no es sancionable?",
          answers:[
            {text:"CK",isCorrect:true},{text:"MG",isCorrect:false},{text:"RK",isCorrect:false},
            {text:"PK",isCorrect:true},{text:"IDP",isCorrect:true},{text:"DM",isCorrect:false}
          ]},
        { q:"¬øCuando se permite hacer MG?",
          answers:[
            {text:"Siempre que no entorpezca roles ajenos o administrativos y no te de ninguna ventaja IC.",isCorrect:false},
            {text:"Nunca, todo aquello que conoce tu pj debe haberlo presenciado, escuchado o visto IC.",isCorrect:true},
            {text:"En cualquier situaci√≥n excepto en los PVP.",isCorrect:false}
          ]},
        { q:"¬øQu√© significa IC?",
          answers:[
            {text:"In Conversation.",isCorrect:false},{text:"In Character.",isCorrect:true},
            {text:"In Combat.",isCorrect:false},{text:"In Community.",isCorrect:false}
          ]}
      ]},
      { title: "Conocimientos Generales 2/5", questions: [
        { q:"¬øA qu√© se refieren las siglas OOC?",
          answers:[
            {text:"Se refiere a las conversaciones por voz dentro del juego.",isCorrect:false},
            {text:"Se refiere a las conversaciones y acciones que est√°n fuera del contexto del rol y no afectan la narrativa del personaje.",isCorrect:true},
            {text:"Se refiere a las conversaciones que ocurren exclusivamente en el chat del juego.",isCorrect:false}
          ]},
        { q:"¬øQu√© es el RDE y qu√© significa?",
          answers:[
            {text:"Significa Rol de Entorno, son ciudadanos, c√°maras y vida en la ciudad que debemos tener en cuenta en todo momento para tener una interpretaci√≥n correcta en la ciudad.",isCorrect:true},
            {text:"Significa Roll Death Eyes, son los NPC que estan cerca de tu personaje y avisan a la polic√≠a o EMS cuando estas muerto.",isCorrect:false},
            {text:"Significa Rol de Espera, es el tiempo que debes esperar tras la muerte de tu personaje para poder recordar como has muerto y quien fue el culpable.",isCorrect:false}
          ]},
        { q:"¬øPara qu√© se utiliza el comando /me?",
          answers:[
            {text:"Se utilizar√° para acciones que realiza nuestro personaje y no exista animaci√≥n para ello.",isCorrect:true},
            {text:"Se utilizar√° para especificar las acciones que tengan que ver con el entorno que nos rodea.",isCorrect:false},
            {text:"Se utiliza para expresar las acciones y pensamientos de tu personaje.",isCorrect:false}
          ]}
      ]},
      { title: "Conocimientos Generales 3/5", questions: [
        { q:"¬øPor qu√© no se permite el RK?",
          answers:[
            {text:"Porque despu√©s de acabar inconsciente, no recuerdas el rol que te llev√≥ a dicho estado.",isCorrect:true},
            {text:"Porque tengo que esperar 30 minutos para poder volver a un PVP.",isCorrect:false},
            {text:"Si est√° permitido.",isCorrect:false}
          ]},
        { q:"Cu√°l de los siguientes comentarios no se considera una falta de interpretaci√≥n?",
          answers:[
            {text:"Voy a descansar un rato, luego nos vemos.",isCorrect:true},
            {text:"¬øCon qu√© m√∫sculo me pongo el cintur√≥n?",isCorrect:false},
            {text:"Voy a parpadear que no te veo los brazos.",isCorrect:false},
            {text:"Mira qu√© dice la nube.",isCorrect:false}
          ]},
        { q:"¬øSe permiten los roles sexuales?",
          answers:[
            {text:"Si, siempre que exista consentimiento de los participantes.",isCorrect:true},
            {text:"No.",isCorrect:false}
          ]}
      ]},
      { title: "Conocimientos Generales 4/5", questions: [
        { q:"¬øCu√°l de los siguientes ejemplos no son aptos para la elecci√≥n de nombre de personaje?",
          answers:[
            {text:"Nombres de Familiares cercanos.",isCorrect:false},
            {text:"Nombres Reales.",isCorrect:false},
            {text:"Nombres ofensivos o con doble sentido.",isCorrect:true},
            {text:"Nombres de Famosos.",isCorrect:true},
            {text:"Nombres de Personajes Ficticios.",isCorrect:true},
            {text:"Nombres extranjeros.",isCorrect:false}
          ]},
        { q:"¬øQu√© se necesita para publicar contenido sobre PROYECTO ROLEPLAY",
          answers:[
            {text:"Mencionar el nombre del servidor en el t√≠tulo del video o streaming.",isCorrect:false},
            {text:"El permiso de Creador de Contenido.",isCorrect:true},
            {text:"Nada.",isCorrect:false}
          ]},
        { q:"¬øSe permite el uso de mods en el servidor?",
          answers:[
            {text:"Si, unicamente los que mejoran los gr√°ficos visuales.",isCorrect:true},
            {text:"No, ning√∫n tipo de mod est√° permitido.",isCorrect:false}
          ]}
      ]},
      { title: "Conocimientos Generales 5/5", questions: [
        { q:"¬øC√≥mo debes comunicarte con otros jugadores fuera de rol pero dentro del juego?",
          answers:[
            {text:"No puedes comunicarte fuera de rol.",isCorrect:false},
            {text:"Mediante la voz IC pero sin otros jugadores cerca.",isCorrect:false},
            {text:"Con el comando /msg o /ooc",isCorrect:true}
          ]},
        { q:"¬øSe permiten los roles de tortura?",
          answers:[
            {text:"Si, siempre que exista la aprobaci√≥n administrativa y rol previo",isCorrect:false},
            {text:"No, no se permiten ese tipo de roles tan increpantes",isCorrect:false},
            {text:"Si, pero en casos de desmembramientos debes tener la aprobaci√≥n OOC de la v√≠ctima",isCorrect:true}
          ]},
        { q:"¬øCu√°l de estas descripciones del comando /do no es correcta?",
          answers:[
            {text:"/do se podr√≠a leer en la nota la palabra S.O.S",isCorrect:false},
            {text:"/do ¬øhabr√≠a alg√∫n arma dentro del bolso?",isCorrect:false},
            {text:"/do pensar√≠a en el hambre que tiene.",isCorrect:true},
            {text:"/do se escuchar√≠a el rugir de sus tripas.",isCorrect:false}
          ]}
      ]},
      { title: "Situaciones de rol 1/5", questions: [
        { q:"Un staff te comunica por /msg que acudas a sala de reporte ¬øC√≥mo debes actuar?",
          answers:[
            {text:"Tratar de terminar el rol actual si existiese e ir a sala de espera.",isCorrect:true},
            {text:"Ignorarlo y seguir roleando.",isCorrect:false},
            {text:"Desconectarme e ignorar el mensaje.",isCorrect:false},
            {text:"Quedarme AFK e ir a sala de espera.",isCorrect:false}
          ]},
        { q:"Despu√©s de un d√≠a duro de trabajo y de problemas en tu vida, decides irte a tu bar de confianza a llorar tus penas y a beberte una botella de Absenta. ¬øQu√© no debes hacer en este rol?",
          answers:[
            {text:"Roleas que bebes el licor, pero no consumes el √≠tem y te lo guardas para despu√©s.",isCorrect:true},
            {text:"Consumo el √≠tem y rolear que bebes el licor.",isCorrect:false},
            {text:"Roleo el beber el licor y consumo el √≠tem pero no roleo que voy embriagad@.",isCorrect:true},
            {text:"Roleo el beber el licor pero tiro el √≠tem. ",isCorrect:true}
          ]},
        { q:"¬øCu√°l de los siguientes roles ser√≠a el adecuado para justificar que llevas m√°s de 15 items de un mismo objeto encima?",
          answers:[
            {text:"Roleas que te entregan los √≠tems mediante una caja y la transportan manualmente dando uso a la animaci√≥n o transporte correspondiente.",isCorrect:true},
            {text:"Roleas que lo guardas en el bolsillo sin tener ning√∫n objeto que justifique donde pueden estar  guardados.",isCorrect:false},
            {text:"Roleo que tengo una mochila enorme.",isCorrect:false},
            {text:"Si llevo el accesorio visual de la mochila guardo una cantidad considerable.",isCorrect:true}
          ]}
      ]},
      { title: "Situaciones de rol 2/5", questions: [
        { q:"Est√°s en medio de un rol que no ha sido pactado con otro jugador y de la nada se te cae la conexi√≥n y te saca del servidor oblig√°ndote a reiniciar. ¬øC√≥mo se ha de proceder?",
          answers:[
            {text:"Los dem√°s jugadores deben frenar el rol moment√°neamente quedandote afk hasta que vuelvas a entrar al servidor.",isCorrect:false},
            {text:"Los dem√°s jugadores deben seguir el rol excusando tu ausencia de forma ingeniosa hasta que puedas reconectar y seguir con el rol.",isCorrect:true},
            {text:"Los dem√°s jugadores se tienen que quedar afk para esperarte y de mientras salen de su idp y se ponen a hablar de cosas OOC .",isCorrect:false}
          ]},
        { q:"Acabas de ser secuestrado por unos enmascarados que te han maniatado y obligado a subir a un coche, sin darte tiempo de reacci√≥n te han metido a la fuerza dentro de un flecca y te han obligado a arrodillarte delante de la puerta con intenci√≥n de que te vea la polic√≠a. ¬øQu√© haces en ese momento?",
          answers:[
            {text:"Tratas de hacerte valiente e intentar noquear a alguno de los enmascarados para apoderarte de su arma y tratar de huir.",isCorrect:false},
            {text:"Haces caso a las indicaciones de los enmascarados y esperas paciente y con cautela a que la polic√≠a venga en tu ayuda.",isCorrect:true},
            {text:"Te haces amigo de los atracadores y te unes a ellos haciendo de reh√©n y qued√°ndote una parte del bot√≠n.",isCorrect:false}
          ]},
        { q:"9 amigos excursionistas y t√∫ hab√©is decidido subir al monte andando para realizar una excursi√≥n y tirarnos en paraca√≠das desde la cima. Estando a mitad del camino un puma los ataca dejando a m√°s de la mitad del grupo herido.¬øComo procedes a este rol?",
          answers:[
            {text:"Llamas al equipo de emergencia para que os intenten evacuar mediante helic√≥ptero o camioneta para llevaros a un centro sanitario cercano a curar las heridas.",isCorrect:true},
            {text:"Tus compa√±eros no heridos y t√∫ tratas de arrastrar a los dem√°s heridos exponiendolos a un nuevo ataque o problemas por el camino en la bajada.",isCorrect:false},
            {text:"Trat√°is de arrastrar a los heridos hasta la cima y os tirais todos juntos en paraca√≠das tratando de llegar a una zona donde haya un centro sanitario.",isCorrect:false}
          ]}
      ]},
      { title: "Situaciones de rol 3/5", questions: [
        { q:"Esta √∫ltima semana finalmente le has realizado un ck a tu pj. Hoy por fin te has decidido y te has creado un personaje nuevo que llega a la ciudad. Elige la respuesta correcta.",
          answers:[
            {text:"Camino por la ciudad con el nuevo personaje reconociendo los lugares y las personas con las que interact√∫e con el personaje anterior.",isCorrect:false},
            {text:"Como el personaje es completamente nuevo no puedo acordarme de las personas o lugares que haya conocido con el anterior personaje.",isCorrect:true},
            {text:"Voy por la ciudad conociendo todo de nuevo y me acuerdo de algunos personajes de otros jugadores porque son mis amigos.",isCorrect:false}
          ]},
        { q:"Est√°s tranquilamente caminando cuando de repente recibes una llamada an√≥nima, amenaz√°ndote y pidi√©ndote dinero. En medio de la llamada, reconoces que esa voz es la del due√±o del casino. ¬øC√≥mo continuar√≠as el rol?",
          answers:[
            {text:"Me hago el loco y acato sus instrucciones.",isCorrect:true},
            {text:"Le insultar√≠a, le mencionar√≠a su nombre y le dir√≠a que le voy a mandar cuatro sicarios al casino a partirle las piernas.",isCorrect:false},
            {text:"Me hago el loco, espero un rato y voy al casino a preguntar a los trabajadores si han escuchado al jefe amenazar a alguien por tel√©fono.",isCorrect:false}
          ]},
        { q:"Hace nada has empezado un rol de pareja con otr@ jugador, como quer√©is ir a m√°s y profundizar la relaci√≥n IC, propones realizar un rol de car√°cter sexual con dicha persona.",
          answers:[
            {text:"No se puede realizar dicho rol ya que est√° prohibido realizar roles de car√°cter sexual.",isCorrect:false},
            {text:"Se puede realizar dicho rol siempre y cuando las dos personas est√©n de acuerdo en realizarlo.",isCorrect:true},
            {text:"Fuerzas indirectamente al otr@ jugador/a a realizar dicho rol sin tener su consentimiento.",isCorrect:false}
          ]}
      ]},
      { title: "Situaciones de rol 4/5", questions: [
        { q:"Tu y tu amigo est√°s roleando con otros jugadores en GC, sin querer, en medio de un rol, tu amigo se deja el micr√≥fono encendido y se escuchan conversaciones OC.¬øQu√© haces en esta situaci√≥n?",
          answers:[
            {text:"Paramos el rol de inmediato y avisamos por voz saliendo del pj que se ha dejado el micr√≥fono encendido.",isCorrect:false},
            {text:"Trat√°is de continuar con el rol haciendo caso omiso a lo que ha dicho tu amigo y mediante mensaje privado le avisas de que se ha dejado el micr√≥fono abierto.posteriormente segu√≠s el rol como si no hubiera pasado nada.",isCorrect:true},
            {text:"Parais el rol moment√°neamente y escrib√≠s por el chat oc para avisar a tu amigo. Os qued√°is Afk hasta que solucione el problema hablando de vuestras cosas por discord. Posteriormente haceis regresi√≥n de rol y seguis.",isCorrect:false}
          ]},
        { q:"Te encuentras en un garaje sacando un veh√≠culo, de repente aparece un enmascarado con una pistola, el cual te dice que est√°s secuestrado y que a la m√≠nima tonter√≠a te pegar√° un tiro. ¬øC√≥mo actuar√≠as?",
          answers:[
            {text:"Sacar√≠a una pistola y le disparar√≠a hasta dejarlo en el suelo en coma y luego me reiria de el.",isCorrect:false},
            {text:"Le dir√≠a IC que en el garaje no me puede robar, que se vaya o, si no, rezar√≠a para que lo deportaran de la ciudad por intentar robarme en una zona segura.",isCorrect:false},
            {text:"Seguir√≠a sus indicaciones.",isCorrect:true}
          ]},
        { q:"Estas en el hospital y te percatas de que un jugador nada mas entrar en el hospital empieza a dar pu√±etazos a todo el mundo sin mediar palabra. ¬øC√≥mo no deber√≠as actuar?",
          answers:[
            {text:"Me uno a dar pu√±etazos, la culpa es del que empieza.",isCorrect:true},
            {text:"Me escondo en alg√∫n lugar donde no pueda pegarme y aviso al staff con el comando /reporte",isCorrect:false},
            {text:"Saco una SMG y le abro la cabeza para que deje de hacer antirol.",isCorrect:true}
          ]}
      ]},
      { title: "Situaciones de rol 5/5", questions: [
        { q:"Durante un rol de secuestro siendo tu el rehen empiezas a valorar que los secuestradores empiezan a ser excesivamente maleducados contigo ¬øC√≥mo deber√≠as actuar frente ese rol?",
          answers:[
            {text:"Tomo mala actitud por el desagrado llegando a insultar pero manteniendo la cooperaci√≥n.",isCorrect:true},
            {text:"Insisto por el chat OOC que se est√°n pasando y si no paran me desconecto.",isCorrect:false},
            {text:"Continuo el rol pero reporto.",isCorrect:false}
          ]},
        { q:"Tu personaje es un m√©dico y acudes a un aviso de un jugador inconsciente, y resulta que este te cae mal en el rol. ¬øQu√© no puedes hacer?",
          answers:[
            {text:"Le atiendo pero no sin antes escupirle en la boca por payaso.",isCorrect:false},
            {text:"Aprovecho la situaci√≥n para dejar que se muera definitivamente y si puedo hago que sufra en el proceso.",isCorrect:true},
            {text:"Le atiendo pero pongo una excusa para cobrarle 1.000$",isCorrect:false}
          ]},
        { q:"Est√°s en el metro esperando el tren, a los minutos otro jugador comienza a cantar rancheras mexicanas pidiendo limosna, pero los ideales racistas de tu personaje hacen que te sientas completamente inc√≥modo. ¬øCu√°l de estas acciones no tendr√≠a consecuencias OOC? ",
          answers:[
            {text:"Comienzas una batalla de miradas tensas y cuando llega el tren, mientras subes le gritas: cierra el pico chimpanc√©.",isCorrect:true},
            {text:"Dejas caer un billete de 500$ junto a las v√≠as y cuando este lo recoge del suelo aprovechas para darle una patada en el culo para que sea atropellado por el tren.",isCorrect:false},
            {text:"Le acercas un cuchillo al cuello, comienzas a dar tu discurso xen√≥fobo y sin intenciones de matarlo pero s√≠ de herirlo lo apu√±alas.",isCorrect:false},
            {text:"Cualquier acci√≥n, comentario o comportamiento racista, xen√≥foba o discriminatoria IC est√° prohibida. Las ideolog√≠as de los personajes deben ser respetuosas.",isCorrect:false}
          ]}
      ]}
    ];
    const TOTAL_STEPS = 11;

    /* ====== DOM refs ====== */
    const card = document.querySelector('.card');
    const progressEl = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressLabel = document.getElementById('progressLabel');

    const avatarEl = document.getElementById("avatar");
    const nameEl = document.getElementById("name");
    const hintEl = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");
    const startWrap = document.getElementById("startWrap");
    const startBtn = document.getElementById("startBtn");

    const viewWelcome = document.getElementById("welcome");
    const viewStep1 = document.getElementById("step1");
    const viewQuiz = document.getElementById("quiz");
    const viewResult = document.getElementById("result");

    const form1 = document.getElementById("formStep1");
    const errEdad = document.getElementById("err-edad");
    const errPais = document.getElementById("err-pais");
    const errExp = document.getElementById("err-exp");

    const quizTitle = document.getElementById("quiz-title");
    const quizQ = document.getElementById("quiz-q");
    const quizOptions = document.getElementById("quiz-options");
    const quizError = document.getElementById("quiz-error");
    const quizForm = document.getElementById("quiz-form");

    const scoreText = document.getElementById("scoreText");

    /* ====== Estado ====== */
    let currentUser = null; // usuario verificado

    const state = {
      step1:{},
      quizChoice:{},       // √≠ndice de pregunta elegida por p√°gina
      answerOrder:{},      // orden barajado de respuestas por p√°gina (√≠ndices originales)
      selectedAnswers:{},  // respuestas marcadas por el usuario (en √≠ndice original)
      score:0,
      currentQuizIndex:0
    };

    /* ====== Utilidades UI ====== */
    const cdn = (p)=>`/cdn${p}`;
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setProgress(step){ const pct=Math.round(step/TOTAL_STEPS*100); progressFill.style.width=pct+"%"; progressLabel.textContent=`Paso ${step} de ${TOTAL_STEPS}`; }
    function setWelcomeMode(){ card.classList.remove('quiz'); progressEl.classList.remove('quiz'); }
    function setQuizMode(){ card.classList.add('quiz'); progressEl.classList.add('quiz'); }

    function revealAvatar(url){
      const done=()=>{ avatarEl.classList.remove("hidden"); requestAnimationFrame(()=>avatarEl.classList.add("revealed")); };
      avatarEl.addEventListener("load",done,{once:true});
      avatarEl.addEventListener("error",()=>{ avatarEl.addEventListener("load",done,{once:true}); avatarEl.src=cdn(`/embed/avatars/0.png?size=256`); },{once:true});
      avatarEl.src=url;
    }

    const showUser = (u)=>{
      currentUser = u;
      const display = u?.global_name || u?.username || "Usuario";
      let url = cdn(`/embed/avatars/0.png?size=256`);
      if(u?.avatar) url = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);
      revealAvatar(url);
      nameEl.innerHTML = `Bienvenido al sistema de whitelist de Proyecto Roleplay <span class="username">${escapeHtml(display)}</span>`;
      hintEl.textContent=""; spinnerEl.style.display="none"; show(startWrap);
    };
    const fail=(t,d)=>{ nameEl.textContent=t; hintEl.textContent=d||""; hintEl.classList.add("err"); spinnerEl.style.display="none"; avatarEl.classList.add("hidden"); };

    /* ====== SDK loader (v√≠a Worker /api/sdk-src) ====== */
    async function loadSDKViaBlob(){
      const r = await fetch(`/api/sdk-src?ts=${Date.now()}`,{cache:"no-store"});
      const txt = await r.text();
      if(!r.ok) throw new Error(`sdk_src_${r.status}: ${txt.slice(0,120)}`);
      const url = URL.createObjectURL(new Blob([txt],{type:"text/javascript"}));
      try{ const mod = await import(/* webpackIgnore: true */ url); URL.revokeObjectURL(url); return mod.DiscordSDK||(mod.default?.DiscordSDK||mod.default)||mod; }
      catch(e){ URL.revokeObjectURL(url); throw new Error(`sdk_import_failed: ${e?.message||e}`); }
    }

    /* ====== Paso 0 ‚Üí 1 ====== */
    startBtn?.addEventListener("click", ()=>{
      hide(viewWelcome); show(progressEl); setProgress(1); setWelcomeMode(); show(viewStep1); document.getElementById("edad").focus();
    });

    /* ====== Validaci√≥n paso 1 ====== */
    form1.addEventListener("submit",(e)=>{
      e.preventDefault();
      errEdad.textContent=""; errPais.textContent=""; errExp.textContent="";
      const edad=(document.getElementById("edad").value||"").trim();
      const pais=(document.getElementById("pais").value||"").trim();
      const exp=(form1.querySelector('input[name="exp"]:checked')?.value||"").trim();
      const conocido=(document.getElementById("conocido").value||"").trim();
      let ok=true;
      if(!edad){ errEdad.textContent="La edad es obligatoria."; ok=false; }
      if(!pais){ errPais.textContent="El pa√≠s es obligatorio."; ok=false; }
      if(!exp){ errExp.textContent="Selecciona tu experiencia."; ok=false; }
      if(!ok) return;
      state.step1={edad,pais,exp,conocido};
      startQuizPage(0);
    });

    /* ====== Herramientas quiz ====== */
    function shuffleInPlace(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function startQuizPage(idx){
      setQuizMode();
      state.currentQuizIndex=idx;
      setProgress(2+idx);
      hide(viewStep1); hide(viewResult); show(viewQuiz);

      const page = QUIZ_PAGES[idx];
      quizTitle.textContent = page.title;

      if(state.quizChoice[idx]===undefined){
        state.quizChoice[idx]=Math.floor(Math.random()*page.questions.length);
      }
      const q = page.questions[state.quizChoice[idx]];
      quizQ.textContent = q.q;

      if(!state.answerOrder[idx]){
        state.answerOrder[idx] = shuffleInPlace(q.answers.map((_, i)=>i)); // √≠ndices originales mezclados
      }
      const order = state.answerOrder[idx];
      const shuffled = order.map(i=>q.answers[i]);

      quizOptions.innerHTML="";
      shuffled.forEach((ans, i)=>{
        const id=`q${idx}-a${i}`;
        const lbl=document.createElement("label");
        lbl.className="check";
        const input=document.createElement("input");
        input.type="checkbox"; input.id=id; input.name="opt";
        input.dataset.originalIndex = order[i];
        input.dataset.correct = ans.isCorrect ? "1":"0";
        const span=document.createElement("span"); span.textContent=ans.text;
        lbl.appendChild(input); lbl.appendChild(span);
        quizOptions.appendChild(lbl);
      });
      quizError.textContent="";
    }

    quizForm.addEventListener("submit",(e)=>{
      e.preventDefault();
      const idx = state.currentQuizIndex;
      const inputs = [...quizOptions.querySelectorAll('input[type="checkbox"]')];
      const selected = inputs.filter(i=>i.checked);

      if(selected.length===0){
        quizError.textContent="Selecciona al menos una opci√≥n.";
        return;
      }

      state.selectedAnswers[idx] = selected.map(i=>Number(i.dataset.originalIndex));

      const totalCorrect = inputs.filter(i=>i.dataset.correct==="1").length;
      const selectedIncorrect = selected.some(i=>i.dataset.correct!=="1");
      const selectedCorrectCount = selected.filter(i=>i.dataset.correct==="1").length;

      const isExactly = !selectedIncorrect && selectedCorrectCount===totalCorrect && totalCorrect>0;
      if(isExactly) state.score++;

      if(idx+1<QUIZ_PAGES.length){
        startQuizPage(idx+1);
      }else{
        hide(viewQuiz);
        setProgress(TOTAL_STEPS);
        setWelcomeMode();
        show(viewResult);

        const result = state.score >= RESULT_THRESHOLD ? "Aprobado" : "Suspenso";
        scoreText.innerHTML =
          "Tu Whitelist se ha enviado exitosamente<br>" +
          "Podr√°s encontrar tu resultado en unos segundos en el canal";

        // Enviar al webhook directamente desde el HTML
        sendReportToWebhookDirect(result).catch(()=>{ /* no bloqueamos UI */ });
      }
    });

    /* ====== Webhook directo ====== */
    async function sendReportToWebhookDirect(resultLabel){
      try{
        const now = new Date();
        const usuario = currentUser?.global_name || currentUser?.username || "Usuario";
        const avatar = currentUser?.avatar
          ? cdn(`/avatars/${currentUser.id}/${currentUser.avatar}.png?size=256`)
          : cdn(`/embed/avatars/0.png?size=256`);

        const embed1 = {
          author: { name: `${usuario}`, icon_url: avatar },
          title: "Whitelist ‚Äî Resumen",
          color: 0x7b5cff,
          fields: [
            { name: "ID de Discord", value: `\`${currentUser?.id || "N/D"}\``, inline: true },
            { name: "Resultado (provisional)", value: `**${resultLabel}**`, inline: true },
            { name: "Puntuaci√≥n", value: `**${state.score}/10**`, inline: true },
            { name: "Edad", value: state.step1.edad || "N/D", inline: true },
            { name: "Pa√≠s", value: state.step1.pais || "N/D", inline: true },
            { name: "Experiencia en rol", value: state.step1.exp || "N/D", inline: true },
            { name: "Fecha y hora", value: now.toLocaleString("es-ES"), inline: true }
          ],
          footer: { text: "Proyecto Roleplay ‚Äî Sistema de Whitelist" }
        };

        const fields = [];
        for(let i=0;i<QUIZ_PAGES.length;i++){
          const page = QUIZ_PAGES[i];
          const qi = state.quizChoice[i];
          const q = page.questions[qi];
          const selectedOriginalIdxs = new Set(state.selectedAnswers[i] || []);
          const shownOrder = state.answerOrder[i] || q.answers.map((_,k)=>k);

          let value = `**${q.q}**\n`;
          shownOrder.forEach((origIdx)=>{
            const ans = q.answers[origIdx];
            const sel = selectedOriginalIdxs.has(origIdx);
            const mark = sel ? (ans.isCorrect ? "‚úÖ" : "‚ùå") : "‚óªÔ∏è";
            const correctness = ans.isCorrect ? " (correcta)" : "";
            value += `${mark} ${ans.text}${correctness}\n`;
          });
          if(value.length > 1024) value = value.slice(0, 1000) + "‚Ä¶";
          fields.push({ name: `P${i+2}: ${page.title}`, value });
        }
        const embed2 = { title: "Detalle del cuestionario", color: 0x5edae7, fields };

        const payload = { embeds:[embed1, embed2] };

        // Llamada directa al webhook
        await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        }).catch(()=>{ /* algunos clientes pueden bloquear por CORS */ });
      }catch(_e){}
    }

    /* ====== Arranque: verificar usuario ====== */
    (async ()=>{
      try{
        hintEl.textContent="Identificando usuario‚Ä¶";
        const DiscordSDK = await loadSDKViaBlob();
        const sdk = new DiscordSDK(CLIENT_ID);
        await Promise.race([sdk.ready(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout_ready")),10000))]);
        const { code } = await sdk.commands.authorize({ client_id:CLIENT_ID, response_type:"code", scope:["identify"], prompt:"none" });
        const tres = await fetch("/api/token",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ code }) });
        const tok = await tres.json();
        if(!tres.ok || !tok?.access_token) throw new Error("token_exchange_failed");
        await sdk.commands.authenticate({ access_token: tok.access_token });
        const meRes = await fetch("/api/@me",{ headers:{ Authorization:`Bearer ${tok.access_token}` } });
        const me = await meRes.json();
        if(!meRes.ok) throw new Error("me_failed");
        showUser(me);
      }catch(e){
        const msg=String(e?.message||e);
        if(msg.includes("timeout_ready"))        fail("Sin handshake con Discord","√Åbrelo como Embedded Activity de esta app.");
        else if(msg.startsWith("sdk_"))          fail("No carga el SDK","Revisa el mapping /api y que /api/sdk-src responda 200.");
        else if(msg==="token_exchange_failed")    fail("Fallo de autorizaci√≥n","Comprueba el DISCORD_CLIENT_SECRET en el Worker.");
        else                                      fail("Error", msg);
      }
    })();
  </script>
</body>
</html>
