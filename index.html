<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity — Perfil</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family: system-ui, Segoe UI, Roboto, sans-serif; }
  .card { width:340px; padding:20px; border:1px solid #1e293b; border-radius:16px; background:#0f172a; box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; }
  img { width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 12px; }
  h1 { font-size:18px; margin:8px 0 0; color:#e2e8f0; }
  p  { font-size:13px; margin:6px 0 0; color:#94a3b8; }
  .spinner { width:24px; height:24px; border:3px solid #334155; border-top-color:#60a5fa; border-radius:50%; margin:18px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg) } }
  .err { color:#fca5a5 }
  .ok  { color:#86efac }
  code { background:#111827; padding:0 6px; border-radius:6px; }
</style>
</head>
<body>
  <div class="card">
    <img id="avatar" alt="Avatar" src="" />
    <h1 id="name">Cargando…</h1>
    <p id="hint">Iniciando SDK</p>
    <div class="spinner" id="spinner"></div>
  </div>

  <!-- Carga del SDK como módulo desde el Worker -->
  <script type="module" src="/api/sdk" id="sdk"></script>

  <!-- Lógica de la Activity -->
  <script>
    const CLIENT_ID = "1383517896747126987";

    const avatarEl  = document.getElementById("avatar");
    const nameEl    = document.getElementById("name");
    const hintEl    = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");
    const cdn = (p) => `/cdn${p}`;

    const ok = (u) => {
      const display = u?.global_name || u?.username || "Usuario";
      let avatar = cdn(`/embed/avatars/0.png`);
      if (u?.avatar) avatar = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);
      avatarEl.src = avatar;
      nameEl.textContent = display;
      hintEl.innerHTML = `<span class="ok">OK</span> ID: ${u?.id ?? "desconocido"}`;
      spinnerEl.style.display = "none";
    };
    const err = (t, d) => { nameEl.textContent = t; hintEl.innerHTML = d; hintEl.classList.add("err"); spinnerEl.style.display = "none"; };

    // Espera a que cargue el módulo del SDK
    const sdkScript = document.getElementById("sdk");
    sdkScript.addEventListener("error", () => {
      err("No carga el SDK", "Revisa el mapping <code>/api</code> y que <code>/api/sdk</code> responda 200.");
    });
    sdkScript.addEventListener("load", async () => {
      try {
        if (!window.DiscordSDK) {
          return err("No carga el SDK", "El Worker debe exponer <code>globalThis.DiscordSDK</code> en <code>/api/sdk</code>.");
        }
        const { DiscordSDK } = window;

        hintEl.textContent = "Esperando handshake de Discord…";
        const sdk = new DiscordSDK(CLIENT_ID);
        await Promise.race([ sdk.ready(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),8000)) ]);

        hintEl.textContent = "Autorizando…";
        const { code } = await sdk.commands.authorize({
          client_id: CLIENT_ID,
          response_type: "code",
          state: "",
          prompt: "none",
          scope: ["identify"]
        });

        const tres = await fetch("/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code })
        });
        const t = await tres.json();
        if (!tres.ok || !t?.access_token) throw new Error("token_exchange_failed");

        await sdk.commands.authenticate({ access_token: t.access_token });

        const meRes = await fetch("/api/@me", { headers: { Authorization: `Bearer ${t.access_token}` } });
        const me = await meRes.json();
        if (!meRes.ok) throw new Error("me_failed");
        ok(me);
      } catch (e) {
        console.error(e);
        if (String(e?.message).includes("timeout")) {
          err("Sin handshake con Discord", "Ábrelo como <b>Embedded Activity</b> de esta app.");
        } else {
          err("Fallo de autorización", "Confirma <code>CLIENT_ID</code>/<code>CLIENT_SECRET</code> en el Worker.");
        }
      }
    });
  </script>
</body>
</html>
