<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity — Whitelist</title>
<style>
  :root { color-scheme: dark; --card-w: 420px; }
  body { margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family: system-ui, Segoe UI, Roboto, sans-serif; }

  /* Layout principal */
  .stack{ display:grid; gap:16px; place-items:center; }

  /* Logo centrado arriba */
  .brand-center{
    width:72px; height:auto; user-select:none; -webkit-user-drag:none;
    filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
  }

  /* Progreso */
  .progress{ width:var(--card-w); text-align:center; }
  .progress-track{
    height:10px; border-radius:9999px; overflow:hidden;
    background: rgba(255,255,255,.15);
    box-shadow: inset 0 1px 2px rgba(0,0,0,.25);
  }
  .progress-fill{
    height:100%; width:0%;
    background: linear-gradient(135deg,#5edae7,#885dfd);
    border-radius:9999px; transition:width .35s ease;
  }
  .progress-label{
    font-size:12px; color:#e5e7eb; margin-top:6px; opacity:.9;
  }
  .hidden{ display:none !important; }

  /* Tarjeta */
  .card{ width:var(--card-w); padding:24px; border-radius:20px;
    background: linear-gradient(135deg,#5edae7,#885dfd);
    box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; color:#fff; border:none; }
  .inner{ background: rgba(0,0,0,0.25); border-radius:16px; padding:18px; }

  /* Avatar oculto hasta que cargue */
  img.avatar{ width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 14px; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,.25); opacity:0; transition:opacity .25s ease; }
  img.avatar.hidden{ display:none; }
  img.avatar.revealed{ display:block; opacity:1; }

  /* Títulos/estado */
  h1{ font-size:20px; margin:8px 0 0; color:#ffffff; font-weight:700; min-height:1.2em; }
  #hint{ font-size:20px; font-weight:700; margin:6px 0 0; color:#ffffff; min-height:1.2em; opacity:.95; }
  .username{ color:#0c121e; }

  /* Spinner */
  .spinner{ width:24px; height:24px; border:3px solid rgba(255,255,255,.35); border-top-color:#ffffff; border-radius:50%; margin:18px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .err{ color:#ffe1e1 }

  /* Botones */
  .btn{ appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700; font-size:14px; transition: transform .05s ease, box-shadow .2s ease, opacity .2s ease; }
  .btn-primary{ background:#fff; color:#0b0f14; box-shadow:0 8px 18px rgba(0,0,0,.25); }
  .btn-primary:hover{ transform:translateY(-1px); }
  .btn-primary:active{ transform:translateY(0); }
  .gtext{ background-image:linear-gradient(135deg,#5edae7,#885dfd); -webkit-background-clip:text; background-clip:text; color:transparent; display:inline-block; }

  /* Formulario */
  .step-title{ font-size:16px; font-weight:700; margin:0 0 12px; opacity:.95; }
  .form{ text-align:left; }
  .field{ margin:10px 0 14px; }
  .label{ display:block; font-size:13px; margin-bottom:6px; color:#eef2ff; }
  .req{ color:#ffd3d3; margin-left:6px; font-size:12px; }

  .input, .textarea{
    width:100%; box-sizing:border-box; border-radius:12px;
    border:1px solid transparent; background: rgba(0,0,0,.18);
    color:#fff; padding:10px 12px; font-size:14px; outline:none;
  }
  .input:focus, .textarea:focus{ border-color:#fff; background: rgba(255,255,255,.08); }

  .radios{ display:grid; grid-template-columns:1fr; gap:8px; }
  .radio{
    display:flex; align-items:center; gap:10px; padding:10px 12px;
    border:1px solid transparent; border-radius:12px; background: rgba(0,0,0,.18);
    transition:border-color .2s ease, background .2s ease;
  }
  .radio input{ appearance:none; width:18px; height:18px; border-radius:50%; border:2px solid transparent; background:transparent; box-shadow: inset 0 0 0 9px transparent; }
  .radio:has(input:focus-visible){ border-color:#fff; }
  .radio:has(input:checked){ border-color:#fff; background: rgba(255,255,255,.08); }
  .radio input:checked{ box-shadow: inset 0 0 0 9px #fff; }

  .error{ color:#ffd3d3; font-size:12px; margin-top:6px; }
  .actions{ display:flex; gap:10px; justify-content:center; margin-top:8px; }
</style>
</head>
<body>
  <div class="stack">
    <!-- Logo centrado -->
    <img class="brand-center" src="logo.png" alt="Proyecto Roleplay" />

    <!-- Barra de progreso (se muestra desde el Paso 1) -->
    <div id="progress" class="progress hidden" aria-hidden="true">
      <div class="progress-track"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressLabel" class="progress-label">Paso 1 de 2</div>
    </div>

    <!-- Tarjeta -->
    <div class="card">
      <div class="inner">

        <!-- Bienvenida -->
        <section id="welcome">
          <img id="avatar" class="avatar hidden" alt="" />
          <h1 id="name"></h1>
          <p id="hint">Identificando usuario…</p>
          <div class="spinner" id="spinner"></div>
          <div id="startWrap" class="hidden" style="margin-top:14px;">
            <button id="startBtn" type="button" class="btn btn-primary">
              <span class="gtext">Comenzar whitelist</span>
            </button>
          </div>
        </section>

        <!-- Paso 1 -->
        <section id="step1" class="hidden" aria-labelledby="step1-title">
          <p id="step1-title" class="step-title">Datos del jugador</p>
          <form id="formStep1" class="form" novalidate>
            <div class="field">
              <label class="label" for="edad">Edad <span class="req">*</span></label>
              <input id="edad" name="edad" class="input" type="text" inputmode="numeric" autocomplete="off" required />
              <div class="error" id="err-edad"></div>
            </div>

            <div class="field">
              <label class="label" for="pais">País <span class="req">*</span></label>
              <input id="pais" name="pais" class="input" type="text" autocomplete="country-name" required />
              <div class="error" id="err-pais"></div>
            </div>

            <div class="field">
              <span class="label">Experiencia en rol <span class="req">*</span></span>
              <div class="radios" role="radiogroup">
                <label class="radio"><input type="radio" name="exp" value="principiante" required /> Principiante</label>
                <label class="radio"><input type="radio" name="exp" value="intermedia" /> Intermedia</label>
                <label class="radio"><input type="radio" name="exp" value="avanzada" /> Avanzada</label>
              </div>
              <div class="error" id="err-exp"></div>
            </div>

            <div class="field">
              <label class="label" for="conocido">¿Cómo nos has conocido? <span style="opacity:.7">(opcional)</span></label>
              <textarea id="conocido" name="conocido" class="textarea"></textarea>
            </div>

            <div class="actions">
              <button type="submit" class="btn btn-primary">
                <span class="gtext">Siguiente</span>
              </button>
            </div>
          </form>
        </section>

        <!-- Paso 2 (placeholder) -->
        <section id="step2" class="hidden">
          <p class="step-title">Formulario — Paso 2</p>
          <p style="opacity:.9">¡Perfecto! Aquí añadimos el siguiente bloque de preguntas.</p>
        </section>

      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = "1383517896747126987";

    // UI refs
    const progress      = document.getElementById("progress");
    const progressFill  = document.getElementById("progressFill");
    const progressLabel = document.getElementById("progressLabel");

    const avatarEl  = document.getElementById("avatar");
    const nameEl    = document.getElementById("name");
    const hintEl    = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");
    const startWrap = document.getElementById("startWrap");
    const startBtn  = document.getElementById("startBtn");

    const viewWelcome = document.getElementById("welcome");
    const viewStep1   = document.getElementById("step1");
    const viewStep2   = document.getElementById("step2");

    const form1   = document.getElementById("formStep1");
    const errEdad = document.getElementById("err-edad");
    const errPais = document.getElementById("err-pais");
    const errExp  = document.getElementById("err-exp");

    const TOTAL_STEPS = 2; // ajustaremos cuando agreguemos más páginas
    const cdn = (p) => `/cdn${p}`;
    const state = { form: {} };

    // Helpers
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    // Progreso
    function setProgress(step){
      const pct = Math.max(0, Math.min(100, Math.round(step / TOTAL_STEPS * 100)));
      progressFill.style.width = pct + "%";
      progressLabel.textContent = `Paso ${step} de ${TOTAL_STEPS}`;
    }

    // Avatar sólo cuando cargue
    function revealAvatar(url){
      const done = () => {
        avatarEl.classList.remove("hidden");
        requestAnimationFrame(() => avatarEl.classList.add("revealed"));
      };
      avatarEl.addEventListener("load", () => done(), { once:true });
      avatarEl.addEventListener("error", () => {
        avatarEl.addEventListener("load", () => done(), { once:true });
        avatarEl.src = cdn(`/embed/avatars/0.png?size=256`);
      }, { once:true });
      avatarEl.src = url;
    }

    const showUser = (u) => {
      const display = u?.global_name || u?.username || "Usuario";
      let url = cdn(`/embed/avatars/0.png?size=256`);
      if (u?.avatar) url = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);

      revealAvatar(url);
      nameEl.innerHTML = `Bienvenido al sistema de whitelist de Proyecto Roleplay <span class="username">${escapeHtml(display)}</span>`;
      hintEl.textContent = "";
      spinnerEl.style.display = "none";
      show(startWrap); // Mostrar botón "Comenzar"
    };

    const fail = (title, detail) => {
      nameEl.textContent = title;
      hintEl.textContent = detail || "";
      hintEl.classList.add("err");
      spinnerEl.style.display = "none";
      avatarEl.classList.add("hidden");
    };

    async function loadSDKViaBlob(){
      const r = await fetch(`/api/sdk-src?ts=${Date.now()}`, { cache:"no-store" });
      const txt = await r.text();
      if(!r.ok) throw new Error(`sdk_src_${r.status}: ${txt.slice(0,120)}`);
      const url = URL.createObjectURL(new Blob([txt], { type:"text/javascript" }));
      try{
        const mod = await import(/* webpackIgnore: true */ url);
        URL.revokeObjectURL(url);
        return mod.DiscordSDK || (mod.default?.DiscordSDK || mod.default) || mod;
      }catch(e){
        URL.revokeObjectURL(url);
        throw new Error(`sdk_import_failed: ${e?.message || e}`);
      }
    }

    // Navegación
    startBtn?.addEventListener("click", () => {
      hide(viewWelcome);
      show(progress); setProgress(1);          // ← progreso comienza aquí
      show(viewStep1);
      document.getElementById("edad").focus();
    });

    form1.addEventListener("submit", (e) => {
      e.preventDefault();
      errEdad.textContent = ""; errPais.textContent = ""; errExp.textContent = "";

      const edad = (document.getElementById("edad").value || "").trim();
      const pais = (document.getElementById("pais").value || "").trim();
      const exp  = (form1.querySelector('input[name="exp"]:checked')?.value || "").trim();
      const conocido = (document.getElementById("conocido").value || "").trim();

      let ok = true;
      if (!edad) { errEdad.textContent = "La edad es obligatoria."; ok = false; }
      if (!pais) { errPais.textContent = "El país es obligatorio."; ok = false; }
      if (!exp)  { errExp.textContent  = "Selecciona tu experiencia."; ok = false; }
      if (!ok) return;

      state.form.step1 = { edad, pais, exp, conocido };
      hide(viewStep1);
      setProgress(2);
      show(viewStep2);
    });

    // Boot
    (async () => {
      try {
        hintEl.textContent = "Identificando usuario…";
        const DiscordSDK = await loadSDKViaBlob();
        const sdk = new DiscordSDK(CLIENT_ID);
        await Promise.race([ sdk.ready(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout_ready")),10000)) ]);

        const { code } = await sdk.commands.authorize({
          client_id: CLIENT_ID,
          response_type: "code",
          scope: ["identify"],
          prompt: "none"
        });

        const tres = await fetch("/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code })
        });
        const tok = await tres.json();
        if (!tres.ok || !tok?.access_token) throw new Error("token_exchange_failed");

        await sdk.commands.authenticate({ access_token: tok.access_token });

        const meRes = await fetch("/api/@me", { headers: { Authorization: `Bearer ${tok.access_token}` } });
        const me = await meRes.json();
        if (!meRes.ok) throw new Error("me_failed");

        showUser(me);
      } catch (e) {
        const msg = String(e?.message || e);
        if (msg.includes("timeout_ready")) fail("Sin handshake con Discord","Ábrelo como Embedded Activity de esta app.");
        else if (msg.startsWith("sdk_"))  fail("No carga el SDK","Revisa el mapping /api y que /api/sdk-src responda 200.");
        else if (msg === "token_exchange_failed") fail("Fallo de autorización","Comprueba el DISCORD_CLIENT_SECRET en el Worker.");
        else fail("Error", msg);
      }
    })();
  </script>
</body>
</html>
