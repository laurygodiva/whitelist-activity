<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity — Perfil</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family: system-ui, Segoe UI, Roboto, sans-serif; }
  .card {
    width:380px; padding:24px; border-radius:20px;
    background: linear-gradient(135deg, #5edae7, #885dfd);
    box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; color:#fff; border:none;
  }
  .inner { background: rgba(0,0,0,0.25); border-radius:16px; padding:16px; }
  img { width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 14px; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,.25); }
  .hidden { display:none; }
  h1 { font-size:18px; margin:8px 0 0; color:#ffffff; font-weight:700; min-height:1.2em; }
  p  { font-size:13px; margin:6px 0 0; color:#eef2ff; min-height:1.2em; opacity:.9; }
  .spinner { width:24px; height:24px; border:3px solid rgba(255,255,255,.35); border-top-color:#ffffff; border-radius:50%; margin:18px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg) } }
  .err { color:#ffe1e1 }
</style>
</head>
<body>
  <div class="card">
    <div class="inner">
      <img id="avatar" alt="" class="hidden" />
      <h1 id="name"></h1>
      <p id="hint">Identificando usuario…</p>
      <div class="spinner" id="spinner"></div>
    </div>
  </div>

  <script>
    const CLIENT_ID = "1383517896747126987";
    const avatarEl  = document.getElementById("avatar");
    const nameEl    = document.getElementById("name");
    const hintEl    = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");
    const cdn = (p) => `/cdn${p}`;

    const showUser = (u) => {
      const display = u?.global_name || u?.username || "Usuario";
      let avatar = cdn(`/embed/avatars/0.png`);
      if (u?.avatar) avatar = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);
      avatarEl.src = avatar;
      avatarEl.classList.remove("hidden");      // ← mostrar avatar solo cuando ya está
      nameEl.textContent = `Bienvenido al sistema de whitelist de Proyecto Roleplay ${display}`;
      hintEl.textContent = "";                  // ← ocultar mensaje de carga
      spinnerEl.style.display = "none";
    };
    const fail = (title, detail) => {
      nameEl.textContent = title;
      hintEl.textContent = detail || "";
      hintEl.classList.add("err");
      spinnerEl.style.display = "none";
      avatarEl.classList.add("hidden");         // ← nada de círculo vacío si falla
    };

    async function loadSDKViaBlob() {
      const r = await fetch(`/api/sdk-src?ts=${Date.now()}`, { cache: "no-store" });
      const txt = await r.text();
      if (!r.ok) throw new Error(`sdk_src_${r.status}: ${txt.slice(0,120)}`);
      const url = URL.createObjectURL(new Blob([txt], { type: "text/javascript" }));
      try {
        const mod = await import(/* webpackIgnore: true */ url);
        URL.revokeObjectURL(url);
        return mod.DiscordSDK || (mod.default?.DiscordSDK || mod.default) || mod;
      } catch (e) {
        URL.revokeObjectURL(url);
        throw new Error(`sdk_import_failed: ${e?.message || e}`);
      }
    }

    (async () => {
      try {
        // Mostrar solo “Identificando usuario…” mientras todo carga.
        const DiscordSDK = await loadSDKViaBlob();
        const sdk = new DiscordSDK(CLIENT_ID);
        await Promise.race([
          sdk.ready(),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout_ready")),10000))
        ]);

        const { code } = await sdk.commands.authorize({
          client_id: CLIENT_ID,
          response_type: "code",
          scope: ["identify"],
          prompt: "none"              // RPC OAuth2 (sin redirect_uri)
        });

        const tres = await fetch("/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code })
        });
        const tok = await tres.json();
        if (!tres.ok || !tok?.access_token) throw new Error("token_exchange_failed");

        await sdk.commands.authenticate({ access_token: tok.access_token });

        const meRes = await fetch("/api/@me", { headers: { Authorization: `Bearer ${tok.access_token}` } });
        const me = await meRes.json();
        if (!meRes.ok) throw new Error("me_failed");

        showUser(me);
      } catch (e) {
        const msg = String(e?.message || e);
        if (msg.includes("timeout_ready")) {
          fail("Sin handshake con Discord", "Ábrelo como Embedded Activity de esta app.");
        } else if (msg.startsWith("sdk_")) {
          fail("No carga el SDK", "Revisa el mapping /api y que /api/sdk-src responda 200.");
        } else if (msg === "token_exchange_failed") {
          fail("Fallo de autorización", "Comprueba el DISCORD_CLIENT_SECRET en el Worker.");
        } else {
          fail("Error", msg);
        }
      }
    })();
  </script>
</body>
</html>
