<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity — Perfil (debug)</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family: system-ui, Segoe UI, Roboto, sans-serif; }
  .card { width:380px; padding:20px; border:1px solid #1e293b; border-radius:16px; background:#0f172a; box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; }
  img { width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 12px; }
  h1 { font-size:18px; margin:8px 0 0; color:#e2e8f0; }
  p  { font-size:13px; margin:6px 0 0; color:#94a3b8; }
  pre { text-align:left; white-space:pre-wrap; word-break:break-word; background:#0b1220; border:1px solid #1e293b; padding:10px; border-radius:10px; color:#cbd5e1; font-size:12px; max-height:180px; overflow:auto; }
  .spinner { width:24px; height:24px; border:3px solid #334155; border-top-color:#60a5fa; border-radius:50%; margin:18px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg) } }
  .err { color:#fca5a5 }
  .ok  { color:#86efac }
  code { background:#111827; padding:0 6px; border-radius:6px; }
</style>
</head>
<body>
  <div class="card">
    <img id="avatar" alt="Avatar" src="" />
    <h1 id="name">Cargando…</h1>
    <p id="hint">Iniciando SDK</p>
    <div class="spinner" id="spinner"></div>
    <pre id="log" style="display:none"></pre>
  </div>

  <script>
    const CLIENT_ID = "1383517896747126987";

    const avatarEl  = document.getElementById("avatar");
    const nameEl    = document.getElementById("name");
    const hintEl    = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");
    const logEl     = document.getElementById("log");
    const cdn = (p) => `/cdn${p}`;

    const showLog = (title, obj) => {
      logEl.style.display = "block";
      logEl.textContent = `[${new Date().toISOString()}] ${title}\n` +
        (typeof obj === "string" ? obj : JSON.stringify(obj, null, 2));
    };

    const ok = (u) => {
      const display = u?.global_name || u?.username || "Usuario";
      let avatar = cdn(`/embed/avatars/0.png`);
      if (u?.avatar) avatar = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);
      avatarEl.src = avatar;
      nameEl.textContent = display;
      hintEl.innerHTML = `<span class="ok">OK</span> ID: ${u?.id ?? "desconocido"}`;
      spinnerEl.style.display = "none";
    };
    const err = (t, d, dbg=null) => {
      nameEl.textContent = t;
      hintEl.innerHTML = d;
      hintEl.classList.add("err");
      spinnerEl.style.display = "none";
      if (dbg) showLog(t, dbg);
    };

    async function loadSDKViaBlob() {
      hintEl.textContent = "Descargando SDK…";
      const r = await fetch(`/api/sdk-src?ts=${Date.now()}`, { cache: "no-store" });
      const txt = await r.text();
      if (!r.ok) throw new Error(`sdk_src_${r.status}: ${txt.slice(0,200)}`);
      const url = URL.createObjectURL(new Blob([txt], { type: "text/javascript" }));
      try {
        const mod = await import(/* webpackIgnore: true */ url);
        URL.revokeObjectURL(url);
        return mod.DiscordSDK || (mod.default?.DiscordSDK || mod.default) || mod;
      } catch (e) {
        URL.revokeObjectURL(url);
        throw new Error(`sdk_import_failed: ${e?.message || e}`);
      }
    }

    (async () => {
      try {
        const DiscordSDK = await loadSDKViaBlob();
        hintEl.textContent = "Handshake con Discord…";
        const sdk = new DiscordSDK(CLIENT_ID);

        try {
          await Promise.race([
            sdk.ready(),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout_ready")),10000))
          ]);
        } catch (e) {
          return err("Sin handshake con Discord",
            "Asegúrate de abrirlo como <b>Embedded Activity</b> de <b>esta app</b>.",
            e?.message || e);
        }

        hintEl.textContent = "Solicitando código OAuth…";
        let auth;
        try {
          auth = await sdk.commands.authorize({
            client_id: CLIENT_ID,
            response_type: "code",
            state: "",
            prompt: "none",
            scope: ["identify"]
          });
        } catch (e) {
          return err("Fallo en authorize()", "El cliente no devolvió código (scope: <code>identify</code>).", e?.message || e);
        }
        if (!auth?.code) {
          return err("Authorize sin código", "No se recibió <code>code</code> del cliente.", auth);
        }
        showLog("authorize()", auth);

        hintEl.textContent = "Intercambiando token…";
        const tres = await fetch("/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: auth.code })
        });
        const tokBodyText = await tres.text();
        let tok;
        try { tok = JSON.parse(tokBodyText); } catch { tok = { raw: tokBodyText }; }
        showLog("POST /api/token", { status: tres.status, body: tok });
        if (!tres.ok || !tok?.access_token) {
          return err("token_exchange_failed",
            "Revisa el <b>DISCORD_CLIENT_SECRET</b> del Worker (rota el secreto en el portal y actualiza el Worker).",
            { status: tres.status, tok });
        }

        hintEl.textContent = "Autenticando con el SDK…";
        try {
          await sdk.commands.authenticate({ access_token: tok.access_token });
        } catch (e) {
          return err("authenticate() falló", "El cliente no aceptó el access_token.", e?.message || e);
        }

        hintEl.textContent = "Cargando tu perfil…";
        const meRes = await fetch("/api/@me", { headers: { Authorization: `Bearer ${tok.access_token}` } });
        const meText = await meRes.text();
        let me; try { me = JSON.parse(meText); } catch { me = { raw: meText }; }
        showLog("GET /api/@me", { status: meRes.status, body: me });
        if (!meRes.ok) {
          return err("Error en /@me", "El token no es válido para <code>users/@me</code>.", { status: meRes.status, me });
        }

        ok(me);
      } catch (e) {
        console.error(e);
        err("Error inesperado", "Revisa la consola de la Activity (Ctrl/Cmd+Shift+I).", e?.message || e);
      }
    })();
  </script>
</body>
</html>
