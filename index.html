<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sistema de Whitelist de Proyecto Roleplay</title>
<style>
  :root{--bg:#0b0f14;--panel:#111b28;--panel-2:#122033;--muted:#a4b5c6;--text:#fff;
    --grad1:#885efc;--grad2:#5edae7;--grad3:#70a4f0;--grad4:#7b84f5;
    --alpha-header-1:.14;--alpha-header-2:.12;--alpha-section-1:.08;--alpha-section-2:.06;
    --radius:16px;--shadow:0 10px 30px rgba(0,0,0,.30)}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 500px at -20% -20%, color-mix(in srgb, var(--grad1) calc(var(--alpha-header-1)*100%), transparent), transparent 60%),
    radial-gradient(1200px 500px at 120% -30%,  color-mix(in srgb, var(--grad2) calc(var(--alpha-header-2)*100%), transparent), transparent 60%),
    var(--bg); color:var(--text); font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{min-height:100%;padding:20px;display:grid;place-items:center}
  .card{width:min(825px,100%);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015)),var(--panel);
    border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:18px 22px;
    border-bottom:1px solid rgba(255,255,255,.08);
    background:linear-gradient(120deg,
      color-mix(in srgb,var(--grad1) calc(var(--alpha-header-1)*100%),transparent),
      color-mix(in srgb,var(--grad2) calc(var(--alpha-header-2)*100%),transparent) 40%,
      color-mix(in srgb,var(--grad3) calc(var(--alpha-header-2)*100%),transparent) 70%,
      color-mix(in srgb,var(--grad4) calc(var(--alpha-header-1)*100%),transparent) 100%)}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:96px;height:96px;border-radius:14px;object-fit:cover}
  .title{font-size:18px;font-weight:900;letter-spacing:.3px}
  .muted{color:var(--muted);font-weight:600;font-size:14px}
  #statusTag{display:none}
  .content{padding:18px 18px 20px}
  .grid{display:grid;grid-template-columns:1fr 1.1fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .section{background:
      linear-gradient(135deg,
        color-mix(in srgb,var(--grad1) calc(var(--alpha-section-1)*100%),transparent),
        color-mix(in srgb,var(--grad2) calc(var(--alpha-section-2)*100%),transparent) 35%,
        color-mix(in srgb,var(--grad3) calc(var(--alpha-section-2)*100%),transparent) 70%,
        color-mix(in srgb,var(--grad4) calc(var(--alpha-section-1)*100%),transparent) 100%),
      var(--panel-2); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px}
  h3{margin:0 0 8px;font-size:16px;background-image:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3),var(--grad4));
    -webkit-background-clip:text;background-clip:text;color:transparent}
  .t-center{text-align:center}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .label{font-size:13px;color:var(--muted);font-weight:800;letter-spacing:.25px}
  .input,.select,textarea{background:#0f1a28;color:var(--text);border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:10px 12px}
  .input:focus,.select:focus,textarea:focus{outline:none;border-color:rgba(112,164,240,.7);box-shadow:0 0 0 3px rgba(112,164,240,.20)}
  .progress{display:flex;align-items:center;gap:8px;margin:6px 0 12px}
  .bar{flex:1;height:8px;background:#0d141c;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3),var(--grad4));width:0%}
  .pill{font-size:12px;color:var(--muted);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);border-radius:999px;padding:4px 8px}
  .q-wrap{display:flex;flex-direction:column;gap:10px}
  .q-block{border:1px solid rgba(255,255,255,.10);border-radius:12px;overflow:hidden}
  .q-head{background:rgba(255,255,255,.03);padding:10px 12px;font-weight:900;
    background-image:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3),var(--grad4));
    -webkit-background-clip:text;background-clip:text;color:transparent}
  .q-body{padding:10px 12px;display:flex;flex-direction:column;gap:8px}
  label.option{display:flex;gap:10px;align-items:flex-start;background:#0e1520;border:1px solid rgba(255,255,255,.09);
    border-radius:10px;padding:10px 12px;cursor:pointer;transition:border .15s ease, box-shadow .15s ease}
  label.option:hover{border-color:rgba(112,164,240,.6);box-shadow:0 0 0 3px rgba(112,164,240,.18)}
  .controls{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
  .btn{border:1px solid rgba(255,255,255,.12);border-radius:11px;padding:10px 14px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));color:var(--text);font-weight:800;cursor:pointer}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn-primary{background:linear-gradient(180deg,var(--grad3),var(--grad4));color:#0b0f14;border-color:transparent}
  .btn-success{background:linear-gradient(180deg,var(--grad2),var(--grad3));color:#0b0f14;border-color:transparent}
  .note{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="brand">
        <img class="logo" src="/logo.png" alt="Logo Proyecto Roleplay"/>
        <div>
          <div class="title">Sistema de Whitelist de Proyecto Roleplay</div>
          <div class="muted">Recomendamos a todos los usuarios leer detenidamente tanto las preguntas como las respuestas.</div>
          <div class="muted">No asuman información que no está escrita.</div>
        </div>
      </div>
      <div class="muted" id="statusTag"></div>
    </header>

    <div class="content">
      <!-- Paso 1 -->
      <div class="grid" id="step1">
        <div class="section">
          <h3 class="t-center">Datos del jugador</h3>
          <div class="field"><label class="label" for="discord">Nombre de Discord</label><input class="input" id="discord"/></div>
          <div class="field"><label class="label" for="edad">Edad</label><input class="input" id="edad" type="number" min="14" max="99"/></div>
          <div class="field"><label class="label" for="region">País/Región</label><input class="input" id="region"/></div>
          <div class="field"><label class="label" for="conoces">¿Cómo nos conociste?</label><input class="input" id="conoces"/></div>
          <div class="field"><label class="label" for="exp">Experiencia en RP</label><textarea id="exp"></textarea></div>
        </div>
        <div class="section">
          <h3>Progreso</h3>
          <div class="progress"><div class="bar"><span id="bar"></span></div><span class="pill" id="pill">0%</span></div>
          <p class="note">Al pulsar “Empezar test” inicia el bloque 3. Se mostrará 1 pregunta por bloque (variantes aleatorias).</p>
          <div class="controls"><button class="btn btn-primary" id="startBtn">Empezar test</button></div>
        </div>
      </div>

      <!-- Paso 2 -->
      <div id="step2" style="display:none">
        <div class="section">
          <div class="controls" style="margin-bottom:8px">
            <span class="pill" id="catPill">—</span>
            <span class="note" id="qIndex">Pregunta 1 de 10</span>
          </div>
          <div class="q-wrap">
            <div class="q-block">
              <div class="q-head" id="qTitle">Pregunta</div>
              <div class="q-body" id="qBody"></div>
            </div>
          </div>
          <div class="controls">
            <button class="btn" id="prevBtn">Anterior</button>
            <button class="btn" id="omitBtn">Omitir</button>
            <button class="btn btn-primary" id="nextBtn" disabled>Siguiente</button>
          </div>
        </div>
      </div>

      <!-- Paso 3 -->
      <div id="step3" style="display:none">
        <div class="section">
          <h3 class="t-center">¡Gracias por completar la Whitelist!</h3>
          <p class="note" style="text-align:center;margin:8px 0 14px">
            Para finalizar, pulsa <b>Enviar whitelist</b>. El equipo revisará tu solicitud.
          </p>
          <div class="controls" style="margin-top:12px">
            <button class="btn" id="backToTest">Volver</button>
            <button class="btn btn-success" id="sendBtn">Enviar whitelist</button>
          </div>
          <p class="note" id="sendNote" style="text-align:center">Los datos se enviarán al staff mediante Webhook.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Config actividad -->
<script>
  window.APP_ID      = '1383517896747126987';
  window.GUILD_ID    = '1383503690136162337';
  window.WEBHOOK_URL = 'https://discord.com/api/webhooks/1385716193066745997/ZoQ-DRAkE9ilPSQZQ23gU1b6uT3U_tMQ8Qcpmgx_2AvyrG8c1Ey75iAVeWKJ4wcKky-e';
</script>

<script>
/* ===================== CARGA DEL SDK POR MAPPING /sdk ===================== */
function status(msg){ const t=document.getElementById('statusTag'); t.style.display='block'; t.textContent=msg; }
(function loadSdk(){
  status('Cargando SDK…');
  const s=document.createElement('script');
  s.src='/sdk';            // <== mapeado a sdk.discord.com/embed.js
  s.async=true;
  s.onload=()=>{ status('SDK cargado.'); initApp(); };
  s.onerror=()=>{ status('Abre como Actividad de Discord (SDK no cargó).'); };
  document.head.appendChild(s);
})();

/* ===================== APLICACIÓN ===================== */
const APP_ID=window.APP_ID||'', GUILD_ID=window.GUILD_ID||'', WEBHOOK_URL=window.WEBHOOK_URL||'';
const $=s=>document.querySelector(s); const bar=$("#bar"), pill=$("#pill");
let USER_ID=null, DISCORD_NAME=null;
function setProgress(p){ if(bar&&pill){ bar.style.width=p+"%"; pill.textContent=Math.round(p)+"%"; } }
function showStep(n){ $("#step1").style.display=n===1?"block":"none"; $("#step2").style.display=n===2?"block":"none"; $("#step3").style.display=n===3?"block":"none"; }
function shuffled(a){ return a.map(v=>({v,r:Math.random()})).sort((x,y)=>x.r-y.r).map(o=>o.v); }
function pickIdx(a){ const i=Math.floor(Math.random()*a.length); return {item:a[i],idx:i}; }
function uuidv4(){ return (crypto?.randomUUID?.()||'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);})); }

async function initApp(){
  if(!window.DiscordSDK){ status('Abre como Actividad de Discord (SDK no cargó).'); return; }
  try{
    const sdk=new window.DiscordSDK(APP_ID);
    await sdk.ready();
    status('Autorizando…');
    const { code } = await sdk.commands.authorize({ client_id:APP_ID, response_type:'code', scope:['identify'] });
    status('Autenticando…');
    const { access_token } = await sdk.commands.authenticate({ client_id:APP_ID, code });
    status('Leyendo /users/@me…');
    const me = await fetch('/discord-api/users/@me', { headers:{ Authorization:'Bearer '+access_token } }).then(r=>r.json());
    if(!me?.id) throw new Error('Sin id en /me');
    USER_ID=String(me.id);
    DISCORD_NAME=me.global_name||me.username||null;
    if(DISCORD_NAME && !$('#discord').value) $('#discord').value=DISCORD_NAME;
    status(`Sesión: ${DISCORD_NAME || USER_ID}`);
    document.getElementById('startBtn').disabled=false;
  }catch(e){
    console.error(e);
    status('No se pudo identificar. Reabre como Actividad.');
    document.getElementById('startBtn').disabled=true;
  }
}

/* ===================== PREGUNTAS (igual que versión anterior) ===================== */
const BLOCKS={ /* ——— (mismo contenido que ya tienes, omitido aquí por brevedad) ——— */ };
// Para ahorrar espacio, pega el bloque completo de preguntas de la última versión aquí.
// (C1..C5 y S1..S5 tal cual te pasé; no cambies textos ni flags)

const CATS=["Conocimientos","Situaciones"];
let QUESTIONS=[], state={i:0,answers:[]};

function renderQ(){
  const t=QUESTIONS.length||10, q=QUESTIONS[state.i];
  $("#qTitle").textContent=q.question;
  $("#catPill").textContent=q.category+(state.i<5?` (Bloque ${state.i+3})`:` (Bloque ${state.i-5+8})`);
  $("#qIndex").textContent=`Pregunta ${state.i+1} de ${t}`;
  const body=$("#qBody"); body.innerHTML="";
  q.answers.forEach((a,idx)=>{
    const lab=document.createElement("label"); lab.className="option";
    const input=document.createElement("input"); input.type=q.multi?"checkbox":"radio"; input.name="q"; input.value=idx;
    input.addEventListener("change",()=>{ $("#nextBtn").disabled = body.querySelectorAll("input:checked").length===0; });
    const span=document.createElement("span"); span.textContent=a.text;
    lab.appendChild(input); lab.appendChild(span); body.appendChild(lab);
  });
  const saved=state.answers[state.i];
  if(saved&&saved.chosenIdx){
    saved.chosenIdx.forEach(v=>{ const el=body.querySelector(`input[value="${v}"]`); if(el) el.checked=true; });
    $("#nextBtn").disabled=saved.chosenIdx.length===0;
  }else $("#nextBtn").disabled=true;
  setProgress(5+(state.i/t)*85);
}

function collect(omit=false){
  const q=QUESTIONS[state.i], body=$("#qBody");
  const sel=[...body.querySelectorAll("input:checked")].map(i=>Number(i.value));
  const correctSet=new Set(q.answers.map((a,i)=>a.isCorrect?i:null).filter(i=>i!==null));
  const chosen=new Set(sel);
  let correct=true;
  if(omit||sel.length===0) correct=false;
  else{ for(const i of chosen){ if(!correctSet.has(i)){ correct=false; break; } }
        if(correct){ for(const i of correctSet){ if(!chosen.has(i)){ correct=false; break; } } }
  }
  state.answers[state.i]={ chosenIdx: omit?[]:sel, correct };
}

function startTest(){
  if(!USER_ID){ alert("No se pudo identificar tu cuenta de Discord. Abre la whitelist como Actividad."); return; }
  if(!$("#discord").value.trim()){ alert("Pon tu nombre de Discord."); return; }
  const keys=["C1","C2","C3","C4","C5","S1","S2","S3","S4","S5"];
  QUESTIONS = keys.map((bk,idx)=>{ const {item,idx:vi}=pickIdx(BLOCKS[bk]);
    const answers=shuffled(item.answers.map(a=>({...a})));
    const category=idx<5?CATS[0]:CATS[1];
    return { id:`${bk}-${vi+1}`,bloque:bk,category,question:item.q,answers,multi:item.answers.filter(a=>a.isCorrect).length>1 };
  });
  state.i=0; state.answers=new Array(QUESTIONS.length);
  setProgress(5); showStep(2); renderQ();
}

function next(){ collect(false); if(state.i<QUESTIONS.length-1){ state.i++; renderQ(); } else { setProgress(100); showStep(3); } }
function omit(){ collect(true);  if(state.i<QUESTIONS.length-1){ state.i++; renderQ(); } else { setProgress(100); showStep(3); } }
function prev(){ if(state.i===0) return; state.i--; renderQ(); }
function computeProv(){ const total=QUESTIONS.length; const correct=state.answers.reduce((a,b)=>a+(b&&b.correct?1:0),0); const wrong=total-correct; return { total, correct, wrong, passed: wrong<=2 }; }
function toProxiedDiscordUrl(u){ return u.replace(/^https?:\/\/(?:ptb\.)?discord\.com\/api/i,'/discord-api'); }

async function send(){
  const { total, correct, wrong, passed } = computeProv();
  const submissionId=uuidv4(), clientTs=Date.now();
  const detail=QUESTIONS.map((q,i)=>{ const s=state.answers[i]||{chosenIdx:[],correct:false}; return {
    id:q.id,bloque:q.bloque,category:q.category,question:q.question,
    answers:q.answers.map(a=>({text:a.text,isCorrect:!!a.isCorrect})),
    chosenIdx:s.chosenIdx, chosenText:s.chosenIdx.map(ix=>q.answers[ix]?.text||""), multi:q.multi }; });
  const playerData={ discordName:$("#discord").value||DISCORD_NAME||"", edad:$("#edad").value||"", region:$("#region").value||"", conoces:$("#conoces").value||"", exp:($("#exp").value||"").slice(0,1000) };
  const attachment={ submissionId,userId:USER_ID,guildId:GUILD_ID,clientTs, provisional:{score:correct,total,wrong,passed}, detail, playerData };
  const embed={ title:"Nueva solicitud de Whitelist", description:"Solicitud enviada desde la Activity.", color:passed?0x46b34b:0xff6b6b,
    fields:[{name:"Usuario",value:`<@${USER_ID}> \`${USER_ID}\``},{name:"Discord",value:playerData.discordName||"—",inline:true},{name:"Edad",value:playerData.edad||"—",inline:true},{name:"Región",value:playerData.region||"—",inline:true},{name:"Conociste por",value:playerData.conoces||"—",inline:true},{name:"Resultado provisional",value:`Score: ${correct}/${total} • Fallos: ${wrong} • ${passed?"APROBADO":"SUSPENSO"}`}],
    footer:{text:"Proyecto Roleplay – Sistema de Whitelist"}, timestamp:new Date(clientTs).toISOString() };
  try{
    document.getElementById('sendNote').textContent="Enviando…";
    const fd=new FormData();
    fd.append("payload_json", JSON.stringify({ username:"Whitelist (Actividad)", embeds:[embed], allowed_mentions:{parse:[]} }));
    const blob=new Blob([JSON.stringify(attachment,null,2)],{type:"application/json"});
    fd.append("files[0]", blob, "submission.json");
    const r=await fetch(toProxiedDiscordUrl(WEBHOOK_URL),{ method:"POST", body:fd });
    if(!r.ok) throw new Error("HTTP "+r.status);
    document.getElementById('sendNote').textContent="¡Enviado! El staff procesará tu solicitud.";
  }catch(e){ console.error(e); document.getElementById('sendNote').textContent="Error al enviar. Reintenta más tarde."; }
}

/* Wiring */
document.addEventListener('click', e=>{
  if(e.target.id==='startBtn') startTest();
  if(e.target.id==='nextBtn')  next();
  if(e.target.id==='omitBtn')  omit();
  if(e.target.id==='prevBtn')  prev();
  if(e.target.id==='backToTest') showStep(2);
  if(e.target.id==='sendBtn') send();
});
showStep(1); setProgress(0); document.getElementById('startBtn').disabled=true;
</script>
</body>
</html>
