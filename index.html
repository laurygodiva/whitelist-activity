<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity — Whitelist</title>

<style>
  :root{
    color-scheme: dark;
    --card-w-welcome: 560px;
    --card-w-quiz:    720px;
  }
  body{ margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family:system-ui, Segoe UI, Roboto, Inter, Arial, sans-serif; }
  .stack{ display:grid; gap:16px; place-items:center; }
  .brand-center{ width:72px; height:auto; user-select:none; -webkit-user-drag:none; filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)); }

  .progress{ width:var(--card-w-welcome); text-align:center; transition:width .25s ease; }
  .progress.quiz{ width:var(--card-w-quiz); }
  .progress-track{ height:10px; border-radius:9999px; overflow:hidden; background:rgba(255,255,255,.15); box-shadow:inset 0 1px 2px rgba(0,0,0,.25); }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(135deg,#5edae7,#885dfd); border-radius:9999px; transition:width .35s ease; }
  .progress-label{ font-size:12px; color:#e5e7eb; margin-top:6px; opacity:.9; }
  .hidden{ display:none !important; }

  .card{ width:var(--card-w-welcome); padding:24px; border-radius:20px; background:linear-gradient(135deg,#5edae7,#885dfd); box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; color:#fff; transition:width .25s ease, padding .2s ease; }
  .inner{ background:rgba(0,0,0,.25); border-radius:16px; padding:18px; display:flex; flex-direction:column; justify-content:center; }

  .card.quiz{ width:var(--card-w-quiz); padding:18px; }
  .card.quiz .inner{ min-height:410px; padding:12px; }

  img.avatar{ width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 14px; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,.25); opacity:0; transition:opacity .25s ease; }
  img.avatar.hidden{ display:none; }
  img.avatar.revealed{ display:block; opacity:1; }

  h1{ font-size:20px; margin:8px 0 0; color:#fff; font-weight:700; min-height:1.2em; }
  #hint{ font-size:20px; font-weight:700; margin:6px 0 0; color:#fff; min-height:1.2em; opacity:.95; }
  .username{ color:#0c121e; }

  .spinner{ width:24px; height:24px; border:3px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; margin:14px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .err{ color:#ffe1e1 }

  .btn{ appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700; font-size:14px; transition:transform .05s ease, box-shadow .2s ease, opacity .2s ease; }
  .btn-primary{ background:#fff; color:#0b0f14; box-shadow:0 8px 18px rgba(0,0,0,.25); text-decoration:none; display:inline-block; }
  .btn-primary:hover{ transform:translateY(-1px); }
  .btn-primary:active{ transform:translateY(0); }
  .gtext{ background-image:linear-gradient(135deg,#5edae7,#885dfd); -webkit-background-clip:text; background-clip:text; color:transparent; display:inline-block; }

  .pill-outline{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:12px; user-select:none;
    border:2px solid transparent;
    background:
      linear-gradient(#0b0f14,#0b0f14) padding-box,
      linear-gradient(135deg,#5edae7,#885dfd) border-box;
    color:#eaf2ff; font-weight:700;
  }

  .step-title, #quiz-title{ font-size:18px; font-weight:800; margin:0 0 8px; color:#0c121e; }
  #quiz-q{ font-weight:700; font-size:16px; line-height:1.25; margin:6px 0 8px; }

  .form{ text-align:left; max-width:520px; margin:0 auto; }
  .card.quiz .form{ max-width:660px; }

  .field{ margin:10px 0 12px; }
  .label{ display:block; font-size:13px; margin-bottom:6px; color:#eef2ff; }
  .req{ color:#ffd3d3; margin-left:6px; font-size:12px; }

  .input, .textarea{ width:100%; box-sizing:border-box; border-radius:12px; border:1px solid transparent; background:rgba(0,0,0,.18); color:#fff; padding:9px 12px; font-size:14px; outline:none; }
  .input:focus, .textarea:focus{ border-color:#fff; background:rgba(255,255,255,.08); }

  .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width:740px){ .row-2{ grid-template-columns:1fr; } }

  .radios, .checks{ display:grid; grid-template-columns:1fr; gap:8px; }
  .check, .radio{ display:flex; align-items:center; gap:12px; padding:8px 14px; border:1px solid rgba(255,255,255,.28); border-radius:14px; background:rgba(0,0,0,.18); transition:border-color .2s ease, background .2s ease; }
  .radio:has(input:focus-visible), .check:has(input:focus-visible){ border-color:#fff; }
  .radio:has(input:checked), .check:has(input:checked){ border-color:#fff; background:rgba(255,255,255,.08); }
  .check span, .radio span{ font-size:14px; line-height:1.25; }

  .radio input, .check input{ appearance:none; width:20px; height:20px; border-radius:50%; border:2px solid #fff; background:transparent; display:inline-block; flex-shrink:0; }
  .radio input:checked, .check input:checked{ background:#0c121e; }

  .error{ color:#ffd3d3; font-size:12px; margin-top:6px; }
  .actions{ display:flex; gap:10px; justify-content:center; margin-top:10px; }
</style>
</head>

<body>
  <div class="stack">
    <img class="brand-center" src="logo.png" alt="Proyecto Roleplay" />

    <div id="progress" class="progress hidden" aria-hidden="true">
      <div class="progress-track"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressLabel" class="progress-label">Paso 1 de 11</div>
    </div>

    <div class="card">
      <div class="inner">
        <!-- Bienvenida -->
        <section id="welcome">
          <img id="avatar" class="avatar hidden" alt="" />
          <h1 id="name"></h1>
          <p id="hint">Identificando usuario…</p>
          <div class="spinner" id="spinner"></div>

          <div id="startWrap" class="hidden" style="margin-top:14px;">
            <button id="startBtn" type="button" class="btn btn-primary">
              <span class="gtext">Comenzar whitelist</span>
            </button>
          </div>
        </section>

        <!-- Paso 1 -->
        <section id="step1" class="hidden" aria-labelledby="step1-title">
          <p id="step1-title" class="step-title">Datos del jugador</p>

          <form id="formStep1" class="form" novalidate>
            <div class="row-2">
              <div class="field">
                <label class="label" for="edad">Edad <span class="req">*</span></label>
                <input id="edad" name="edad" class="input" type="text" inputmode="numeric" autocomplete="off" required />
                <div class="error" id="err-edad"></div>
              </div>
              <div class="field">
                <label class="label" for="pais">País <span class="req">*</span></label>
                <input id="pais" name="pais" class="input" type="text" autocomplete="country-name" required />
                <div class="error" id="err-pais"></div>
              </div>
            </div>

            <div class="field">
              <span class="label">Experiencia en rol <span class="req">*</span></span>
              <div class="radios" role="radiogroup">
                <label class="radio"><input type="radio" name="exp" value="principiante" required /> Principiante</label>
                <label class="radio"><input type="radio" name="exp" value="intermedia" /> Intermedia</label>
                <label class="radio"><input type="radio" name="exp" value="avanzada" /> Avanzada</label>
              </div>
              <div class="error" id="err-exp"></div>
            </div>

            <div class="field">
              <label class="label" for="conocido">¿Cómo nos has conocido? <span style="opacity:.7">(opcional)</span></label>
              <textarea id="conocido" name="conocido" class="textarea" rows="3"></textarea>
            </div>

            <div class="actions">
              <button type="submit" class="btn btn-primary"><span class="gtext">Siguiente</span></button>
            </div>
          </form>
        </section>

        <!-- Cuestionario -->
        <section id="quiz" class="hidden" aria-live="polite">
          <p id="quiz-title" class="step-title"></p>
          <div id="quiz-q"></div>

          <form id="quiz-form" class="form">
            <div id="quiz-options" class="checks"></div>
            <div id="quiz-error" class="error"></div>
            <div class="actions">
              <button id="quiz-next" type="submit" class="btn btn-primary"><span class="gtext">Siguiente</span></button>
            </div>
          </form>
        </section>

        <!-- Final -->
        <section id="result" class="hidden">
          <p class="step-title">¡Gracias!</p>
          <p id="scoreText" style="opacity:.95">
            Tu Whitelist se ha enviado exitosamente<br>
            Podrás encontrar tu resultado en unos segundos en el canal
          </p>
          <div class="pill-outline" style="margin-top:12px;" aria-hidden="true">
            🔔 ┃resultados
          </div>
        </section>

      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = "1383517896747126987";
    const RESULT_THRESHOLD = 7; // ≥7/10 = Aprobado

    /* --- Banco de preguntas (páginas 2–11) tal cual lo definiste --- */
    const QUIZ_PAGES = [/* (idéntico al que ya tienes, omitido aquí por brevedad) */];
    // 👉 Reemplaza esta línea por el bloque completo de QUIZ_PAGES que ya estás usando.

    const TOTAL_STEPS = 11;

    const card = document.querySelector('.card');
    const progressEl = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressLabel = document.getElementById('progressLabel');

    const avatarEl = document.getElementById("avatar");
    const nameEl = document.getElementById("name");
    const hintEl = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");
    const startWrap = document.getElementById("startWrap");
    const startBtn = document.getElementById("startBtn");

    const viewWelcome = document.getElementById("welcome");
    const viewStep1 = document.getElementById("step1");
    const viewQuiz = document.getElementById("quiz");
    const viewResult = document.getElementById("result");

    const form1 = document.getElementById("formStep1");
    const errEdad = document.getElementById("err-edad");
    const errPais = document.getElementById("err-pais");
    const errExp = document.getElementById("err-exp");

    const quizTitle = document.getElementById("quiz-title");
    const quizQ = document.getElementById("quiz-q");
    const quizOptions = document.getElementById("quiz-options");
    const quizError = document.getElementById("quiz-error");
    const quizForm = document.getElementById("quiz-form");

    const scoreText = document.getElementById("scoreText");

    let currentUser = null; // 👈 guardamos el usuario verificado

    const cdn = (p)=>`/cdn${p}`;
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setProgress(step){ const pct=Math.round(step/TOTAL_STEPS*100); progressFill.style.width=pct+"%"; progressLabel.textContent=`Paso ${step} de ${TOTAL_STEPS}`; }
    function setWelcomeMode(){ card.classList.remove('quiz'); progressEl.classList.remove('quiz'); }
    function setQuizMode(){ card.classList.add('quiz'); progressEl.classList.add('quiz'); }

    function revealAvatar(url){
      const done=()=>{ avatarEl.classList.remove("hidden"); requestAnimationFrame(()=>avatarEl.classList.add("revealed")); };
      avatarEl.addEventListener("load",done,{once:true});
      avatarEl.addEventListener("error",()=>{ avatarEl.addEventListener("load",done,{once:true}); avatarEl.src=cdn(`/embed/avatars/0.png?size=256`); },{once:true});
      avatarEl.src=url;
    }

    const showUser = (u)=>{
      currentUser = u; // guardamos
      const display = u?.global_name || u?.username || "Usuario";
      let url = cdn(`/embed/avatars/0.png?size=256`);
      if(u?.avatar) url = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);
      revealAvatar(url);
      nameEl.innerHTML = `Bienvenido al sistema de whitelist de Proyecto Roleplay <span class="username">${escapeHtml(display)}</span>`;
      hintEl.textContent=""; spinnerEl.style.display="none"; show(startWrap);
    };
    const fail=(t,d)=>{ nameEl.textContent=t; hintEl.textContent=d||""; hintEl.classList.add("err"); spinnerEl.style.display="none"; avatarEl.classList.add("hidden"); };

    async function loadSDKViaBlob(){
      const r = await fetch(`/api/sdk-src?ts=${Date.now()}`,{cache:"no-store"});
      const txt = await r.text();
      if(!r.ok) throw new Error(`sdk_src_${r.status}: ${txt.slice(0,120)}`);
      const url = URL.createObjectURL(new Blob([txt],{type:"text/javascript"}));
      try{ const mod = await import(/* webpackIgnore: true */ url); URL.revokeObjectURL(url); return mod.DiscordSDK||(mod.default?.DiscordSDK||mod.default)||mod; }
      catch(e){ URL.revokeObjectURL(url); throw new Error(`sdk_import_failed: ${e?.message||e}`); }
    }

    startBtn?.addEventListener("click", ()=>{
      hide(viewWelcome); show(progressEl); setProgress(1); setWelcomeMode(); show(viewStep1); document.getElementById("edad").focus();
    });

    // ----- Estado -----
    const state = {
      step1:{},
      quizChoice:{},       // índice de pregunta elegida por página
      answerOrder:{},      // orden barajado de respuestas por página (índices originales)
      selectedAnswers:{},  // respuestas marcadas por el usuario (en índice original)
      score:0,
      currentQuizIndex:0
    };

    // Paso 1
    form1.addEventListener("submit",(e)=>{
      e.preventDefault();
      errEdad.textContent=""; errPais.textContent=""; errExp.textContent="";
      const edad=(document.getElementById("edad").value||"").trim();
      const pais=(document.getElementById("pais").value||"").trim();
      const exp=(form1.querySelector('input[name="exp"]:checked')?.value||"").trim();
      const conocido=(document.getElementById("conocido").value||"").trim();
      let ok=true;
      if(!edad){ errEdad.textContent="La edad es obligatoria."; ok=false; }
      if(!pais){ errPais.textContent="El país es obligatorio."; ok=false; }
      if(!exp){ errExp.textContent="Selecciona tu experiencia."; ok=false; }
      if(!ok) return;
      state.step1={edad,pais,exp,conocido};
      startQuizPage(0);
    });

    // Utils
    function shuffleInPlace(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    // Render página de cuestionario
    function startQuizPage(idx){
      setQuizMode();
      state.currentQuizIndex=idx;
      setProgress(2+idx);
      hide(viewStep1); hide(viewResult); show(viewQuiz);

      const page = QUIZ_PAGES[idx];
      quizTitle.textContent = page.title;

      if(state.quizChoice[idx]===undefined){
        state.quizChoice[idx]=Math.floor(Math.random()*page.questions.length);
      }
      const q = page.questions[state.quizChoice[idx]];
      quizQ.textContent = q.q;

      // Barajar respuestas, recordando mapa a índices originales
      if(!state.answerOrder[idx]){
        state.answerOrder[idx] = shuffleInPlace(q.answers.map((_, i)=>i));
      }
      const order = state.answerOrder[idx];
      const shuffled = order.map(i=>q.answers[i]);

      quizOptions.innerHTML="";
      shuffled.forEach((ans, i)=>{
        const id=`q${idx}-a${i}`;
        const lbl=document.createElement("label");
        lbl.className="check";
        const input=document.createElement("input");
        input.type="checkbox"; input.id=id; input.name="opt";
        input.dataset.originalIndex = order[i];     // índice original
        input.dataset.correct = ans.isCorrect ? "1":"0";
        const span=document.createElement("span"); span.textContent=ans.text;
        lbl.appendChild(input); lbl.appendChild(span);
        quizOptions.appendChild(lbl);
      });
      quizError.textContent="";
    }

    // Siguiente en cuestionario
    quizForm.addEventListener("submit",(e)=>{
      e.preventDefault();
      const idx = state.currentQuizIndex;
      const inputs = [...quizOptions.querySelectorAll('input[type="checkbox"]')];
      const selected = inputs.filter(i=>i.checked);

      if(selected.length===0){
        quizError.textContent="Selecciona al menos una opción.";
        return;
      }

      // Guardar qué marcó el usuario (en índices originales)
      state.selectedAnswers[idx] = selected.map(i=>Number(i.dataset.originalIndex));

      const totalCorrect = inputs.filter(i=>i.dataset.correct==="1").length;
      const selectedIncorrect = selected.some(i=>i.dataset.correct!=="1");
      const selectedCorrectCount = selected.filter(i=>i.dataset.correct==="1").length;

      const isExactly = !selectedIncorrect && selectedCorrectCount===totalCorrect && totalCorrect>0;
      if(isExactly) state.score++;

      if(idx+1<QUIZ_PAGES.length){
        startQuizPage(idx+1);
      }else{
        // Fin
        hide(viewQuiz);
        setProgress(TOTAL_STEPS);
        setWelcomeMode();
        show(viewResult);

        const result = state.score >= RESULT_THRESHOLD ? "Aprobado" : "Suspenso";
        scoreText.innerHTML =
          "Tu Whitelist se ha enviado exitosamente<br>" +
          "Podrás encontrar tu resultado en unos segundos en el canal";

        // Enviar log al webhook (vía Worker)
        sendReportToWebhook(result).catch(()=>{ /* no bloqueamos la UI */ });
      }
    });

    // Construye y envía el log al Worker -> Webhook
    async function sendReportToWebhook(resultLabel){
      try{
        const now = new Date();
        const usuario = currentUser?.global_name || currentUser?.username || "Usuario";
        const avatar = currentUser?.avatar
          ? cdn(`/avatars/${currentUser.id}/${currentUser.avatar}.png?size=256`)
          : cdn(`/embed/avatars/0.png?size=256`);

        // Embed 1 — Resumen
        const embed1 = {
          author: { name: `${usuario}`, icon_url: avatar },
          title: "Whitelist — Resumen",
          color: 0x7b5cff, // lila
          fields: [
            { name: "ID de Discord", value: `\`${currentUser?.id || "N/D"}\``, inline: true },
            { name: "Resultado (provisional)", value: `**${resultLabel}**`, inline: true },
            { name: "Puntuación", value: `**${state.score}/10**`, inline: true },
            { name: "Edad", value: state.step1.edad || "N/D", inline: true },
            { name: "País", value: state.step1.pais || "N/D", inline: true },
            { name: "Experiencia en rol", value: state.step1.exp || "N/D", inline: true },
            { name: "Fecha y hora", value: now.toLocaleString("es-ES"), inline: true }
          ],
          footer: { text: "Proyecto Roleplay — Sistema de Whitelist" }
        };

        // Embed 2 — Detalle de preguntas
        const fields = [];
        for(let i=0;i<QUIZ_PAGES.length;i++){
          const page = QUIZ_PAGES[i];
          const qi = state.quizChoice[i];
          const q = page.questions[qi];
          const selectedOriginalIdxs = new Set(state.selectedAnswers[i] || []);
          // Reconstruimos el listado en el orden que se mostró
          const shownOrder = state.answerOrder[i] || q.answers.map((_,k)=>k);

          let value = `**${q.q}**\n`;
          shownOrder.forEach((origIdx)=>{
            const ans = q.answers[origIdx];
            const sel = selectedOriginalIdxs.has(origIdx);
            const mark = sel ? (ans.isCorrect ? "✅" : "❌") : "◻️";
            const correctness = ans.isCorrect ? " (correcta)" : "";
            value += `${mark} ${ans.text}${correctness}\n`;
          });

          // Discord limita 1024 chars por field.value
          if(value.length > 1024) value = value.slice(0, 1000) + "…";

          fields.push({
            name: `P${i+2}: ${page.title}`,
            value
          });
        }

        const embed2 = {
          title: "Detalle del cuestionario",
          color: 0x5edae7, // cian
          fields
        };

        const payload = { embeds: [embed1, embed2] };

        await fetch("/api/report",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
      }catch(_e){}
    }

    (async ()=>{
      try{
        hintEl.textContent="Identificando usuario…";
        const DiscordSDK = await loadSDKViaBlob();
        const sdk = new DiscordSDK(CLIENT_ID);
        await Promise.race([sdk.ready(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout_ready")),10000))]);
        const { code } = await sdk.commands.authorize({ client_id:CLIENT_ID, response_type:"code", scope:["identify"], prompt:"none" });
        const tres = await fetch("/api/token",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ code }) });
        const tok = await tres.json();
        if(!tres.ok || !tok?.access_token) throw new Error("token_exchange_failed");
        await sdk.commands.authenticate({ access_token: tok.access_token });
        const meRes = await fetch("/api/@me",{ headers:{ Authorization:`Bearer ${tok.access_token}` } });
        const me = await meRes.json();
        if(!meRes.ok) throw new Error("me_failed");
        showUser(me);
      }catch(e){
        const msg=String(e?.message||e);
        if(msg.includes("timeout_ready"))        fail("Sin handshake con Discord","Ábrelo como Embedded Activity de esta app.");
        else if(msg.startsWith("sdk_"))          fail("No carga el SDK","Revisa el mapping /api y que /api/sdk-src responda 200.");
        else if(msg==="token_exchange_failed")    fail("Fallo de autorización","Comprueba el DISCORD_CLIENT_SECRET en el Worker.");
        else                                      fail("Error", msg);
      }
    })();
  </script>
</body>
</html>
