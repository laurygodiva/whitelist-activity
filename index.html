<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Discord Activity — Perfil</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; min-height:100dvh; display:grid; place-items:center; background:#0b0f14; font-family: system-ui, Segoe UI, Roboto, sans-serif; }
  .card { width:320px; padding:20px; border:1px solid #1e293b; border-radius:16px; background:#0f172a; box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center; }
  img { width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 12px; }
  h1 { font-size:18px; margin:8px 0 0; color:#e2e8f0; }
  p  { font-size:13px; margin:6px 0 0; color:#94a3b8; }
  .spinner { width:24px; height:24px; border:3px solid #334155; border-top-color:#60a5fa; border-radius:50%; margin:18px auto 0; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg) } }
  .err { color:#fca5a5 }
  .ok  { color:#86efac }
  code { background:#111827; padding:0 6px; border-radius:6px; }
</style>
</head>
<body>
  <div class="card">
    <img id="avatar" alt="Avatar" src="" />
    <h1 id="name">Cargando…</h1>
    <p id="hint">Iniciando SDK</p>
    <div class="spinner" id="spinner"></div>
  </div>

  <script type="module">
    const CLIENT_ID = "1383517896747126987";

    const avatarEl  = document.getElementById("avatar");
    const nameEl    = document.getElementById("name");
    const hintEl    = document.getElementById("hint");
    const spinnerEl = document.getElementById("spinner");

    const cdn = (path) => `/cdn${path}`;
    const ok = (u) => {
      const display = u?.global_name || u?.username || "Usuario";
      let avatar = cdn(`/embed/avatars/0.png`);
      if (u?.avatar) avatar = cdn(`/avatars/${u.id}/${u.avatar}.png?size=256`);
      avatarEl.src = avatar;
      nameEl.textContent = display;
      hintEl.innerHTML = `<span class="ok">OK</span> ID: ${u?.id ?? "desconocido"}`;
      spinnerEl.style.display = "none";
    };
    const err = (title, details) => {
      nameEl.textContent = title;
      hintEl.innerHTML = details;
      hintEl.classList.add("err");
      spinnerEl.style.display = "none";
    };

    async function importSDK() {
      // Probamos diferentes rutas ESM en jsDelivr (sin redirecciones a otros hosts)
      const candidates = [
        "/npm/@discord/embedded-app-sdk@2.2.0/dist/index.mjs",
        "/npm/@discord/embedded-app-sdk@2.2.0/+esm",
        "/npm/@discord/embedded-app-sdk@2/dist/index.mjs",
        "/npm/@discord/embedded-app-sdk@2/+esm"
      ];
      for (const p of candidates) {
        try {
          const mod = await import(p);
          if (mod?.DiscordSDK) return mod.DiscordSDK;
        } catch {}
      }
      throw new Error("no_sdk");
    }

    (async () => {
      // Comprobar que /npm responde (mapping correcto)
      try {
        const ping = await fetch("/npm/@discord/embedded-app-sdk@2.2.0/package.json?ping=" + Date.now(), { cache:"no-store" });
        if (!ping.ok) throw 0;
      } catch {
        return err("No carga el SDK", [
          "Revisa URL Mappings con <b>https://</b>:",
          "• <code>/ → https://laurygodiva.github.io/whitelist-activity/</code>",
          "• <code>/npm → https://cdn.jsdelivr.net</code>",
          "• <code>/cdn → https://cdn.discordapp.com</code>"
        ].join("<br>"));
      }

      // Importar el SDK desde jsDelivr
      let DiscordSDK;
      try {
        DiscordSDK = await importSDK();
      } catch {
        return err("Error importando el SDK", "No se pudo cargar desde <code>jsDelivr</code>. Comprueba el mapping <code>/npm</code>.");
      }

      // Handshake con Discord (timeout 8s)
      hintEl.textContent = "Esperando handshake de Discord…";
      const sdk = new DiscordSDK(CLIENT_ID);
      const ready = sdk.ready();
      const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error("sdk_ready_timeout")), 8000));
      try { await Promise.race([ready, timeout]); }
      catch {
        return err("Sin handshake con Discord", [
          "Abre esto como <b>Embedded Activity</b> de <b>esta misma app</b>.",
          "Verifica que <b>Embedded App</b> está activado y el Root Mapping apunta a GitHub Pages."
        ].join("<br>"));
      }

      // Obtener usuario vía getUser (modo estático)
      hintEl.textContent = "Obteniendo usuario…";
      let me = null;
      try {
        const r1 = await sdk.commands.getUser?.();
        me = r1?.user ?? r1 ?? null;
      } catch {}
      if (!me) {
        try {
          const r2 = await sdk.commands.getUser?.({ id: "me" });
          me = r2?.user ?? r2 ?? null;
        } catch {}
      }
      if (me) return ok(me);

      // Fallback: cliente sin getUser
      return err("El cliente no soporta getUser", [
        "Tu build de Discord aún no expone <code>sdk.commands.getUser</code>.",
        "Opciones:",
        "• Prueba en el cliente Desktop actualizado.",
        "• O pasamos a la Opción B (OAuth con Worker) añadiendo el mapping <code>/api</code>."
      ].join("<br>"));
    })();
  </script>
</body>
</html>
